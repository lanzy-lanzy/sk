<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
        <title>Register - SK Budget</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            primary: '#F3CA52',
                            secondary: '#F6E9B2',
                            tertiary: '#0A6847',
                            quaternary: '#7ABA78',
                        }
                    }
                }
            }
        </script>
        <style>
            @keyframes float {
                0% { transform: translateY(0px) rotate(0deg); }
                50% { transform: translateY(-20px) rotate(10deg); }
                100% { transform: translateY(0px) rotate(0deg); }
            }
            .coin {
                position: absolute;
                opacity: 0.5;
                animation: float 3s ease-in-out infinite;
            }
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.05); }
            }
            .pulse {
                animation: pulse 2s infinite;
            }
            @keyframes slideIn {
                from { transform: translateY(-50px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            .slide-in {
                animation: slideIn 0.5s ease-out;
            }

            /* Mobile optimizations */
            @media (max-width: 640px) {
                .password-requirements {
                    font-size: 0.65rem;
                }
                input, button {
                    font-size: 14px;
                }
            }
        </style>
    </head>
    <body class="bg-gradient-to-br from-secondary via-primary to-quaternary min-h-screen flex items-center justify-center px-4 py-6 overflow-y-auto">
        <div class="coin hidden sm:block" style="top: 10%; left: 10%;">
            <i class="fas fa-coins text-4xl sm:text-6xl text-yellow-500"></i>
        </div>
        <div class="coin hidden sm:block" style="top: 20%; right: 15%;">
            <i class="fas fa-dollar-sign text-3xl sm:text-5xl text-green-500"></i>
        </div>
        <div class="coin hidden sm:block" style="bottom: 15%; left: 20%;">
            <i class="fas fa-piggy-bank text-5xl sm:text-7xl text-pink-500"></i>
        </div>
        <div class="coin hidden sm:block" style="bottom: 25%; right: 10%;">
            <i class="fas fa-chart-line text-4xl sm:text-6xl text-blue-500"></i>
        </div>
        <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-2xl w-full max-w-xs sm:max-w-sm md:max-w-md border-t-4 border-tertiary relative z-10 transition-all duration-300 slide-in my-8">
            <h2 class="text-3xl font-bold text-tertiary mb-6 text-center pulse"><i class="fas fa-user-plus mr-2"></i>Register</h2>
            <p class="text-center text-gray-600 mb-4">After registration, your account will need admin approval before you can log in.</p>
            <form method="post" class="space-y-6" id="registerForm" novalidate>
                {% csrf_token %}
                {% if form.non_field_errors %}
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                    <strong class="font-bold">Error!</strong>
                    <span class="block sm:inline">{{ form.non_field_errors|join:", " }}</span>
                </div>
                {% endif %}
                <div class="relative group">
                    <i class="fas fa-user absolute top-3 left-3 text-gray-400 group-hover:text-tertiary transition-colors duration-300"></i>
                    <input type="text" name="{{ form.username.name }}" id="id_{{ form.username.name }}" class="w-full pl-10 pr-3 py-2 rounded-lg border-2 {% if form.username.errors %}border-red-500{% else %}border-gray-300{% endif %} focus:outline-none focus:border-tertiary transition-all duration-300 bg-gray-50 group-hover:bg-white" placeholder="Username" required>
                    {% if form.username.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.username.errors|join:", " }}</p>
                    {% endif %}
                    <p class="text-gray-500 text-xs mt-1 username-requirements hidden">Username must be 3-20 characters long and can contain letters, numbers, and underscores.</p>
                </div>
                <div class="relative group">
                    <i class="fas fa-envelope absolute top-3 left-3 text-gray-400 group-hover:text-tertiary transition-colors duration-300"></i>
                    <input type="email" name="{{ form.email.name }}" id="id_{{ form.email.name }}" class="w-full pl-10 pr-3 py-2 rounded-lg border-2 {% if form.email.errors %}border-red-500{% else %}border-gray-300{% endif %} focus:outline-none focus:border-tertiary transition-all duration-300 bg-gray-50 group-hover:bg-white" placeholder="Email" required>
                    {% if form.email.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.email.errors|join:", " }}</p>
                    {% endif %}
                    <p class="text-gray-500 text-xs mt-1 email-requirements hidden">Please enter a valid email address.</p>
                </div>
                <div class="relative group">
                    <i class="fas fa-lock absolute top-3 left-3 text-gray-400 group-hover:text-tertiary transition-colors duration-300"></i>
                    <input type="password" name="{{ form.password1.name }}" id="id_{{ form.password1.name }}" class="w-full pl-10 pr-3 py-2 rounded-lg border-2 {% if form.password1.errors %}border-red-500{% else %}border-gray-300{% endif %} focus:outline-none focus:border-tertiary transition-all duration-300 bg-gray-50 group-hover:bg-white" placeholder="Password" required>
                    {% if form.password1.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.password1.errors|join:", " }}</p>
                    {% endif %}
                    <div class="password-strength mt-1 hidden">
                        <div class="flex justify-between mb-1">
                            <span class="text-xs">Password strength:</span>
                            <span class="text-xs font-semibold password-strength-text">Weak</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div class="bg-red-500 h-1.5 rounded-full password-strength-bar" style="width: 10%"></div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-2 gap-y-0">
                            <ul class="text-xs text-gray-500 mt-1 space-y-0.5 password-requirements">
                                <li class="req-length"><i class="fas fa-times-circle text-red-500 mr-1"></i>At least 8 characters</li>
                                <li class="req-uppercase"><i class="fas fa-times-circle text-red-500 mr-1"></i>At least one uppercase letter</li>
                                <li class="req-lowercase"><i class="fas fa-times-circle text-red-500 mr-1"></i>At least one lowercase letter</li>
                            </ul>
                            <ul class="text-xs text-gray-500 mt-1 space-y-0.5">
                                <li class="req-number"><i class="fas fa-times-circle text-red-500 mr-1"></i>At least one number</li>
                                <li class="req-special"><i class="fas fa-times-circle text-red-500 mr-1"></i>At least one special character</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="relative group">
                    <i class="fas fa-lock absolute top-3 left-3 text-gray-400 group-hover:text-tertiary transition-colors duration-300"></i>
                    <input type="password" name="{{ form.password2.name }}" id="id_{{ form.password2.name }}" class="w-full pl-10 pr-3 py-2 rounded-lg border-2 {% if form.password2.errors %}border-red-500{% else %}border-gray-300{% endif %} focus:outline-none focus:border-tertiary transition-all duration-300 bg-gray-50 group-hover:bg-white" placeholder="Confirm Password" required>
                    {% if form.password2.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.password2.errors|join:", " }}</p>
                    {% endif %}
                    <p class="text-red-500 text-xs mt-1 password-match-error hidden">Passwords do not match</p>
                </div>
                <div id="register-error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                    <strong class="font-bold">Error! </strong>
                    <span class="block sm:inline message-text"></span>
                </div>
                <button type="submit" id="registerButton" class="w-full bg-tertiary text-white px-4 py-2 rounded-full hover:bg-quaternary transition duration-300 flex items-center justify-center transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-tertiary focus:ring-opacity-50">
                    <span class="spinner hidden inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>
                    <i class="fas fa-user-plus mr-2"></i>
                    <span class="button-text">Register</span>
                </button>
            </form>
            <p class="mt-6 text-center text-gray-600">
                Already have an account? <a href="{% url 'login' %}" class="text-tertiary hover:text-quaternary font-semibold transition-colors duration-300">Login</a>
            </p>
        </div>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>
            $(document).ready(function() {
                // Show password requirements on focus
                $('#id_{{ form.password1.name }}').on('focus', function() {
                    $('.password-strength').removeClass('hidden');
                });

                // Hide password requirements on blur for mobile
                if (window.innerWidth < 640) {
                    $('#id_{{ form.password1.name }}').on('blur', function() {
                        // Only hide if we're moving to a different field (not just clicking within the field)
                        setTimeout(function() {
                            if (document.activeElement !== document.getElementById('id_{{ form.password1.name }}')) {
                                $('.password-strength').addClass('hidden');
                            }
                        }, 100);
                    });
                }

                // Show username requirements on focus
                $('#id_{{ form.username.name }}').on('focus', function() {
                    $('.username-requirements').removeClass('hidden');
                });

                // Check username availability on blur
                $('#id_{{ form.username.name }}').on('blur', function() {
                    const username = $(this).val().trim();
                    if (username.length > 0) {
                        checkUsernameAvailability(username);
                    }
                });

                // Show email requirements on focus
                $('#id_{{ form.email.name }}').on('focus', function() {
                    $('.email-requirements').removeClass('hidden');
                });

                // Check email availability on blur
                $('#id_{{ form.email.name }}').on('blur', function() {
                    const email = $(this).val().trim();
                    if (email.length > 0 && isValidEmail(email)) {
                        checkEmailAvailability(email);
                    }
                });

                // Function to check username availability
                function checkUsernameAvailability(username) {
                    $.ajax({
                        url: '{% url "check_username_email" %}',
                        data: {
                            'username': username
                        },
                        dataType: 'json',
                        success: function(data) {
                            if (data.is_taken && data.field === 'username') {
                                $('#id_{{ form.username.name }}').addClass('border-red-500').removeClass('border-gray-300');
                                // Check if error message element exists, if not create it
                                let $errorMsg = $('#username-error-message');
                                if ($errorMsg.length === 0) {
                                    $errorMsg = $('<p id="username-error-message" class="text-red-500 text-xs mt-1">' + data.error_message + '</p>');
                                    $('#id_{{ form.username.name }}').parent().append($errorMsg);
                                } else {
                                    $errorMsg.text(data.error_message).removeClass('hidden');
                                }
                            } else {
                                $('#id_{{ form.username.name }}').removeClass('border-red-500').addClass('border-gray-300');
                                $('#username-error-message').addClass('hidden');
                            }
                        }
                    });
                }

                // Function to check email availability
                function checkEmailAvailability(email) {
                    $.ajax({
                        url: '{% url "check_username_email" %}',
                        data: {
                            'email': email
                        },
                        dataType: 'json',
                        success: function(data) {
                            if (data.is_taken && data.field === 'email') {
                                $('#id_{{ form.email.name }}').addClass('border-red-500').removeClass('border-gray-300');
                                // Check if error message element exists, if not create it
                                let $errorMsg = $('#email-error-message');
                                if ($errorMsg.length === 0) {
                                    $errorMsg = $('<p id="email-error-message" class="text-red-500 text-xs mt-1">' + data.error_message + '</p>');
                                    $('#id_{{ form.email.name }}').parent().append($errorMsg);
                                } else {
                                    $errorMsg.text(data.error_message).removeClass('hidden');
                                }
                            } else {
                                $('#id_{{ form.email.name }}').removeClass('border-red-500').addClass('border-gray-300');
                                $('#email-error-message').addClass('hidden');
                            }
                        }
                    });
                }

                // Password strength checker
                $('#id_{{ form.password1.name }}').on('input', function() {
                    const password = $(this).val();
                    let strength = 0;
                    let color = 'red';
                    let text = 'Weak';
                    let width = '20%';

                    // Check requirements
                    const hasLength = password.length >= 8;
                    const hasUppercase = /[A-Z]/.test(password);
                    const hasLowercase = /[a-z]/.test(password);
                    const hasNumber = /[0-9]/.test(password);
                    const hasSpecial = /[^A-Za-z0-9]/.test(password);

                    // Update requirement indicators
                    updateRequirement('length', hasLength);
                    updateRequirement('uppercase', hasUppercase);
                    updateRequirement('lowercase', hasLowercase);
                    updateRequirement('number', hasNumber);
                    updateRequirement('special', hasSpecial);

                    // Calculate strength
                    if (hasLength) strength += 1;
                    if (hasUppercase) strength += 1;
                    if (hasLowercase) strength += 1;
                    if (hasNumber) strength += 1;
                    if (hasSpecial) strength += 1;

                    // Set strength indicator
                    if (strength === 0) {
                        color = 'red';
                        text = 'Very Weak';
                        width = '10%';
                    } else if (strength === 1) {
                        color = 'red';
                        text = 'Weak';
                        width = '20%';
                    } else if (strength === 2) {
                        color = 'orange';
                        text = 'Fair';
                        width = '40%';
                    } else if (strength === 3) {
                        color = 'yellow';
                        text = 'Good';
                        width = '60%';
                    } else if (strength === 4) {
                        color = 'lime';
                        text = 'Strong';
                        width = '80%';
                    } else {
                        color = 'green';
                        text = 'Very Strong';
                        width = '100%';
                    }

                    $('.password-strength-bar').css('width', width).css('background-color', color);
                    $('.password-strength-text').text(text).css('color', color);

                    // Check if passwords match
                    checkPasswordsMatch();
                });

                // Check if passwords match
                $('#id_{{ form.password2.name }}').on('input', function() {
                    checkPasswordsMatch();
                });

                function checkPasswordsMatch() {
                    const password1 = $('#id_{{ form.password1.name }}').val();
                    const password2 = $('#id_{{ form.password2.name }}').val();

                    if (password2 && password1 !== password2) {
                        $('.password-match-error').removeClass('hidden');
                        $('#id_{{ form.password2.name }}').addClass('border-red-500').removeClass('border-gray-300');
                    } else {
                        $('.password-match-error').addClass('hidden');
                        if (!$('#id_{{ form.password2.name }}').hasClass('border-red-500')) {
                            $('#id_{{ form.password2.name }}').removeClass('border-red-500').addClass('border-gray-300');
                        }
                    }
                }

                function updateRequirement(req, isValid) {
                    const $req = $('.req-' + req);
                    if (isValid) {
                        $req.find('i').removeClass('fa-times-circle text-red-500').addClass('fa-check-circle text-green-500');
                    } else {
                        $req.find('i').removeClass('fa-check-circle text-green-500').addClass('fa-times-circle text-red-500');
                    }
                }

                // Form submission with validation
                $('#registerForm').on('submit', function(e) {
                    e.preventDefault();

                    // Basic validation
                    let isValid = true;
                    const username = $('#id_{{ form.username.name }}').val().trim();
                    const email = $('#id_{{ form.email.name }}').val().trim();
                    const password1 = $('#id_{{ form.password1.name }}').val();
                    const password2 = $('#id_{{ form.password2.name }}').val();

                    // Username validation
                    if (!username) {
                        $('#id_{{ form.username.name }}').addClass('border-red-500');
                        isValid = false;
                    } else if ($('#username-error-message').length > 0 && !$('#username-error-message').hasClass('hidden')) {
                        // Username is taken
                        isValid = false;
                    }

                    // Email validation
                    if (!email || !isValidEmail(email)) {
                        $('#id_{{ form.email.name }}').addClass('border-red-500');
                        if (!email) {
                            // Create or update error message
                            let $errorMsg = $('#email-error-message');
                            if ($errorMsg.length === 0) {
                                $errorMsg = $('<p id="email-error-message" class="text-red-500 text-xs mt-1">Please enter your email address.</p>');
                                $('#id_{{ form.email.name }}').parent().append($errorMsg);
                            } else {
                                $errorMsg.text('Please enter your email address.').removeClass('hidden');
                            }
                        } else {
                            // Create or update error message for invalid email
                            let $errorMsg = $('#email-error-message');
                            if ($errorMsg.length === 0) {
                                $errorMsg = $('<p id="email-error-message" class="text-red-500 text-xs mt-1">Please enter a valid email address.</p>');
                                $('#id_{{ form.email.name }}').parent().append($errorMsg);
                            } else {
                                $errorMsg.text('Please enter a valid email address.').removeClass('hidden');
                            }
                        }
                        isValid = false;
                    } else if ($('#email-error-message').length > 0 && !$('#email-error-message').hasClass('hidden')) {
                        // Email is taken
                        isValid = false;
                    }

                    // Password validation
                    if (!password1 || password1.length < 8) {
                        $('#id_{{ form.password1.name }}').addClass('border-red-500');
                        isValid = false;
                    }

                    // Confirm password validation
                    if (!password2 || password1 !== password2) {
                        $('#id_{{ form.password2.name }}').addClass('border-red-500');
                        $('.password-match-error').removeClass('hidden');
                        isValid = false;
                    }

                    if (!isValid) {
                        $('#register-error-message').removeClass('hidden bg-green-100 border-green-400 text-green-700')
                            .addClass('bg-red-100 border-red-400 text-red-700');
                        $('#register-error-message strong').text('Error! ');
                        $('#register-error-message .message-text').text('Please fix the errors in the form.');

                        // Scroll to the error message or register button on mobile
                        if (window.innerWidth < 640) {
                            setTimeout(function() {
                                document.getElementById('registerButton').scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }, 100);
                        }
                        return;
                    }

                    // Check username and email availability before submitting
                    $.when(
                        $.ajax({
                            url: '{% url "check_username_email" %}',
                            data: { 'username': username },
                            dataType: 'json'
                        }),
                        $.ajax({
                            url: '{% url "check_username_email" %}',
                            data: { 'email': email },
                            dataType: 'json'
                        })
                    ).done(function(usernameResponse, emailResponse) {
                        const usernameData = usernameResponse[0];
                        const emailData = emailResponse[0];

                        if (usernameData.is_taken) {
                            $('#id_{{ form.username.name }}').addClass('border-red-500').removeClass('border-gray-300');
                            let $errorMsg = $('#username-error-message');
                            if ($errorMsg.length === 0) {
                                $errorMsg = $('<p id="username-error-message" class="text-red-500 text-xs mt-1">' + usernameData.error_message + '</p>');
                                $('#id_{{ form.username.name }}').parent().append($errorMsg);
                            } else {
                                $errorMsg.text(usernameData.error_message).removeClass('hidden');
                            }

                            $('#register-error-message').removeClass('hidden bg-green-100 border-green-400 text-green-700')
                                .addClass('bg-red-100 border-red-400 text-red-700');
                            $('#register-error-message strong').text('Error! ');
                            $('#register-error-message .message-text').text('Please fix the errors in the form.');

                            // Scroll to the error message or register button on mobile
                            if (window.innerWidth < 640) {
                                setTimeout(function() {
                                    document.getElementById('registerButton').scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }, 100);
                            }
                            return;
                        }

                        if (emailData.is_taken) {
                            $('#id_{{ form.email.name }}').addClass('border-red-500').removeClass('border-gray-300');
                            let $errorMsg = $('#email-error-message');
                            if ($errorMsg.length === 0) {
                                $errorMsg = $('<p id="email-error-message" class="text-red-500 text-xs mt-1">' + emailData.error_message + '</p>');
                                $('#id_{{ form.email.name }}').parent().append($errorMsg);
                            } else {
                                $errorMsg.text(emailData.error_message).removeClass('hidden');
                            }

                            $('#register-error-message').removeClass('hidden bg-green-100 border-green-400 text-green-700')
                                .addClass('bg-red-100 border-red-400 text-red-700');
                            $('#register-error-message strong').text('Error! ');
                            $('#register-error-message .message-text').text('Please fix the errors in the form.');

                            // Scroll to the error message or register button on mobile
                            if (window.innerWidth < 640) {
                                setTimeout(function() {
                                    document.getElementById('registerButton').scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }, 100);
                            }
                            return;
                        }

                        // If we get here, both username and email are available

                        // Show loading state
                        const $button = $('#registerButton');
                        const $spinner = $button.find('.spinner');
                        const $icon = $button.find('i');
                        const $text = $button.find('.button-text');

                        $button.prop('disabled', true);
                        $spinner.removeClass('hidden');
                        $icon.addClass('hidden');
                        $text.text('Registering...');

                        // Get CSRF token
                        const csrftoken = $('input[name="csrfmiddlewaretoken"]').val();

                        // Submit the form via AJAX
                        $.ajax({
                            type: 'POST',
                            url: '{% url "register" %}',
                            data: $('#registerForm').serialize(),
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'X-CSRFToken': csrftoken
                            },
                            success: function(response) {
                                if (response.success) {
                                    // Show success message
                                    $('#register-error-message').removeClass('hidden bg-red-100 border-red-400 text-red-700')
                                        .addClass('bg-green-100 border-green-400 text-green-700');
                                    $('#register-error-message strong').text('Success! ');
                                    $('#register-error-message .message-text').text(response.message || 'Registration successful!');

                                    // Redirect after a short delay
                                    setTimeout(function() {
                                        window.location.href = response.redirect_url || '{% url "login" %}';
                                    }, 2000);
                                } else {
                                    // Show error message
                                    $('#register-error-message').removeClass('hidden bg-green-100 border-green-400 text-green-700')
                                        .addClass('bg-red-100 border-red-400 text-red-700');
                                    $('#register-error-message strong').text('Error! ');
                                    $('#register-error-message .message-text').text(response.error || 'Registration failed. Please try again.');

                                    // Display field-specific errors if available
                                    if (response.errors) {
                                        for (const field in response.errors) {
                                            const fieldId = '#id_' + field;
                                            $(fieldId).addClass('border-red-500');
                                            $(fieldId).parent().find('.text-red-500').text(response.errors[field].join(', '));
                                        }
                                    }

                                    // Reset button state
                                    $button.prop('disabled', false);
                                    $spinner.addClass('hidden');
                                    $icon.removeClass('hidden');
                                    $text.text('Register');

                                    // Scroll to the error message or register button on mobile
                                    if (window.innerWidth < 640) {
                                        setTimeout(function() {
                                            document.getElementById('registerButton').scrollIntoView({ behavior: 'smooth', block: 'center' });
                                        }, 100);
                                    }
                                }
                            },
                            error: function() {
                                // Show generic error message
                                $('#register-error-message').removeClass('hidden bg-green-100 border-green-400 text-green-700')
                                    .addClass('bg-red-100 border-red-400 text-red-700');
                                $('#register-error-message strong').text('Error! ');
                                $('#register-error-message .message-text').text('An error occurred. Please try again.');

                                // Reset button state
                                $button.prop('disabled', false);
                                $spinner.addClass('hidden');
                                $icon.removeClass('hidden');
                                $text.text('Register');

                                // Scroll to the error message or register button on mobile
                                if (window.innerWidth < 640) {
                                    setTimeout(function() {
                                        document.getElementById('registerButton').scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    }, 100);
                                }
                            }
                        });
                    });
                });

                function isValidEmail(email) {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    return emailRegex.test(email);
                }
            });
        </script>
    </body>
</html>
