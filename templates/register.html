<!DOCTYPE html>
{% load static %}
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
        <title>Register - SK Budget</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            primary: '#F3CA52',
                            secondary: '#F6E9B2',
                            tertiary: '#0A6847',
                            quaternary: '#7ABA78',
                        }
                    }
                }
            }
        </script>
        <style>
            @keyframes float {
                0% { transform: translateY(0px) rotate(0deg); }
                50% { transform: translateY(-20px) rotate(10deg); }
                100% { transform: translateY(0px) rotate(0deg); }
            }
            .coin {
                position: absolute;
                opacity: 0.5;
                animation: float 3s ease-in-out infinite;
            }
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.05); }
            }
            .pulse {
                animation: pulse 2s infinite;
            }
            @keyframes slideIn {
                from { transform: translateY(-50px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            .slide-in {
                animation: slideIn 0.5s ease-out;
            }

            /* Mobile optimizations */
            @media (max-width: 640px) {
                .password-requirements {
                    font-size: 0.65rem;
                }
                input, button {
                    font-size: 14px;
                }
            }
        </style>
    </head>
    <body class="bg-gradient-to-br from-secondary via-primary to-quaternary min-h-screen flex items-center justify-center px-4 py-6 overflow-y-auto">
        <div class="coin hidden sm:block" style="top: 10%; left: 10%;">
            <i class="fas fa-coins text-4xl sm:text-6xl text-yellow-500"></i>
        </div>
        <div class="coin hidden sm:block" style="top: 20%; right: 15%;">
            <i class="fas fa-dollar-sign text-3xl sm:text-5xl text-green-500"></i>
        </div>
        <div class="coin hidden sm:block" style="bottom: 15%; left: 20%;">
            <i class="fas fa-piggy-bank text-5xl sm:text-7xl text-pink-500"></i>
        </div>
        <div class="coin hidden sm:block" style="bottom: 25%; right: 10%;">
            <i class="fas fa-chart-line text-4xl sm:text-6xl text-blue-500"></i>
        </div>
        <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-2xl w-full max-w-md sm:max-w-lg md:max-w-2xl border-t-4 border-tertiary relative z-10 transition-all duration-300 slide-in my-8">
            <h2 class="text-3xl font-bold text-tertiary mb-6 text-center pulse"><i class="fas fa-user-plus mr-2"></i>Register</h2>
            <p class="text-center text-gray-600 mb-4">After registration, your account will need admin approval before you can log in.</p>
            <form method="post" class="space-y-6" id="registerForm" enctype="multipart/form-data">
                {% csrf_token %}
                {% if form.non_field_errors %}
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                    <strong class="font-bold">Error!</strong>
                    <span class="block sm:inline">{{ form.non_field_errors|join:", " }}</span>
                </div>
                {% endif %}

                <!-- Registration Code - Full Width -->
                <div class="relative group">
                    <i class="fas fa-key absolute top-3 left-3 text-gray-400 group-hover:text-tertiary transition-colors duration-300"></i>
                    <input type="text" name="{{ form.registration_code.name }}" id="id_{{ form.registration_code.name }}" class="w-full pl-10 pr-3 py-2 rounded-lg border-2 {% if form.registration_code.errors %}border-red-500{% else %}border-gray-300{% endif %} focus:outline-none focus:border-tertiary transition-all duration-300 bg-gray-50 group-hover:bg-white" placeholder="Registration Code" required>
                    {% if form.registration_code.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.registration_code.errors|join:", " }}</p>
                    {% endif %}
                    <p id="registration-code-error-message" class="text-red-500 text-xs mt-1 hidden">Please enter a registration code.</p>
                    <p class="text-gray-500 text-xs mt-1">Enter the registration code provided by an administrator.</p>
                </div>

                <!-- Two Column Layout -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Left Column -->
                    <div class="space-y-6">
                        <!-- First Name -->
                        <div class="relative group">
                            <i class="fas fa-user absolute top-3 left-3 text-gray-400 group-hover:text-tertiary transition-colors duration-300"></i>
                            <input type="text" name="{{ form.first_name.name }}" id="id_{{ form.first_name.name }}" class="w-full pl-10 pr-3 py-2 rounded-lg border-2 {% if form.first_name.errors %}border-red-500{% else %}border-gray-300{% endif %} focus:outline-none focus:border-tertiary transition-all duration-300 bg-gray-50 group-hover:bg-white" placeholder="First Name" required>
                            {% if form.first_name.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.first_name.errors|join:", " }}</p>
                            {% endif %}
                            <p id="id_{{ form.first_name.name }}-error-message" class="text-red-500 text-xs mt-1 hidden">Please enter your first name.</p>
                        </div>

                        <!-- Date of Birth -->
                        <div class="relative group">
                            <i class="fas fa-calendar-alt absolute top-3 left-3 text-gray-400 group-hover:text-tertiary transition-colors duration-300"></i>
                            <input type="date" name="{{ form.date_of_birth.name }}" id="id_{{ form.date_of_birth.name }}" class="w-full pl-10 pr-3 py-2 rounded-lg border-2 {% if form.date_of_birth.errors %}border-red-500{% else %}border-gray-300{% endif %} focus:outline-none focus:border-tertiary transition-all duration-300 bg-gray-50 group-hover:bg-white" required>
                            {% if form.date_of_birth.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.date_of_birth.errors|join:", " }}</p>
                            {% endif %}
                            <p id="id_{{ form.date_of_birth.name }}-error-message" class="text-red-500 text-xs mt-1 hidden">Please enter your date of birth.</p>
                            <p class="text-gray-500 text-xs mt-1">You must be at least 18 years old to register.</p>
                        </div>

                        <!-- Contact Number -->
                        <div class="relative group">
                            <i class="fas fa-phone absolute top-3 left-3 text-gray-400 group-hover:text-tertiary transition-colors duration-300"></i>
                            <input type="text" name="{{ form.contact_number.name }}" id="id_{{ form.contact_number.name }}" class="w-full pl-10 pr-3 py-2 rounded-lg border-2 {% if form.contact_number.errors %}border-red-500{% else %}border-gray-300{% endif %} focus:outline-none focus:border-tertiary transition-all duration-300 bg-gray-50 group-hover:bg-white" placeholder="Contact Number" required>
                            {% if form.contact_number.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.contact_number.errors|join:", " }}</p>
                            {% endif %}
                            <p id="id_{{ form.contact_number.name }}-error-message" class="text-red-500 text-xs mt-1 hidden">Please enter your contact number.</p>
                        </div>

                        <!-- Address -->
                        <div class="relative group">
                            <i class="fas fa-map-marker-alt absolute top-3 left-3 text-gray-400 group-hover:text-tertiary transition-colors duration-300"></i>
                            <div class="space-y-2">
                                <!-- Province (Fixed to Zamboanga del Sur) -->
                                <div class="relative">
                                    <input type="text" name="province" id="id_province" class="w-full pl-10 pr-3 py-2 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-tertiary transition-all duration-300 bg-gray-100 text-gray-600" value="Zamboanga del Sur" readonly>
                                    <input type="hidden" name="{{ form.address.name }}" id="id_{{ form.address.name }}" value="">
                                </div>

                                <!-- Municipality (Fixed to Dumingag) -->
                                <div class="relative">
                                    <input type="text" name="municipality" id="id_municipality" class="w-full pl-10 pr-3 py-2 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-tertiary transition-all duration-300 bg-gray-100 text-gray-600" value="Dumingag" readonly>
                                </div>

                                <!-- Barangay (Dropdown) -->
                                <div class="relative">
                                    <select name="barangay" id="id_barangay" class="w-full pl-10 pr-3 py-2 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-tertiary transition-all duration-300 bg-gray-50 group-hover:bg-white" required>
                                        <option value="">Select Barangay</option>
                                        <!-- Barangays will be populated via JavaScript -->
                                    </select>
                                </div>
                                <p id="id_barangay-error-message" class="text-red-500 text-xs mt-1 hidden">Please select your barangay.</p>
                            </div>
                            {% if form.address.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.address.errors|join:", " }}</p>
                            {% endif %}
                            <p class="text-gray-500 text-xs mt-1">Select your barangay in Dumingag, Zamboanga del Sur.</p>
                        </div>

                        <!-- Term of Office -->
                        <div class="relative group">
                            <i class="fas fa-calendar-week absolute top-3 left-3 text-gray-400 group-hover:text-tertiary transition-colors duration-300"></i>
                            <input type="text" name="{{ form.term_of_office.name }}" id="id_{{ form.term_of_office.name }}" class="w-full pl-10 pr-3 py-2 rounded-lg border-2 {% if form.term_of_office.errors %}border-red-500{% else %}border-gray-300{% endif %} focus:outline-none focus:border-tertiary transition-all duration-300 bg-gray-50 group-hover:bg-white" placeholder="Term of Office (e.g., 2023-2026)" required>
                            {% if form.term_of_office.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.term_of_office.errors|join:", " }}</p>
                            {% endif %}
                            <p id="id_{{ form.term_of_office.name }}-error-message" class="text-red-500 text-xs mt-1 hidden">Please enter your term of office.</p>
                        </div>

                        <!-- Profile Picture (Required) -->
                        <div class="relative group">
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0 w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden" id="profilePreviewContainer">
                                    <img id="profilePreview" src="{% static 'images/default_avatar.png' %}" alt="Profile Preview" class="w-full h-full object-cover">
                                </div>
                                <div class="flex-grow">
                                    <label for="id_{{ form.profile_picture.name }}" class="cursor-pointer bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-4 rounded-lg border border-gray-300 inline-flex items-center transition duration-300">
                                        <i class="fas fa-camera mr-2"></i>
                                        <span>Choose Profile Picture</span>
                                    </label>
                                    <input type="file" name="{{ form.profile_picture.name }}" id="id_{{ form.profile_picture.name }}" class="hidden" accept="image/*" required>
                                    <p class="text-gray-500 text-xs mt-1">Required. Upload a profile picture.</p>
                                    <p id="id_{{ form.profile_picture.name }}-error-message" class="text-red-500 text-xs mt-1 hidden">Please upload your profile picture.</p>
                                </div>
                            </div>
                            {% if form.profile_picture.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.profile_picture.errors|join:", " }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="space-y-6">
                        <!-- Last Name -->
                        <div class="relative group">
                            <i class="fas fa-user absolute top-3 left-3 text-gray-400 group-hover:text-tertiary transition-colors duration-300"></i>
                            <input type="text" name="{{ form.last_name.name }}" id="id_{{ form.last_name.name }}" class="w-full pl-10 pr-3 py-2 rounded-lg border-2 {% if form.last_name.errors %}border-red-500{% else %}border-gray-300{% endif %} focus:outline-none focus:border-tertiary transition-all duration-300 bg-gray-50 group-hover:bg-white" placeholder="Last Name" required>
                            {% if form.last_name.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.last_name.errors|join:", " }}</p>
                            {% endif %}
                            <p id="id_{{ form.last_name.name }}-error-message" class="text-red-500 text-xs mt-1 hidden">Please enter your last name.</p>
                        </div>

                        <!-- Gender -->
                        <div class="relative group">
                            <i class="fas fa-venus-mars absolute top-3 left-3 text-gray-400 group-hover:text-tertiary transition-colors duration-300"></i>
                            <select name="{{ form.gender.name }}" id="id_{{ form.gender.name }}" class="w-full pl-10 pr-3 py-2 rounded-lg border-2 {% if form.gender.errors %}border-red-500{% else %}border-gray-300{% endif %} focus:outline-none focus:border-tertiary transition-all duration-300 bg-gray-50 group-hover:bg-white" required>
                                <option value="">Select Gender</option>
                                <option value="male" {% if form.gender.value == "male" %}selected{% endif %}>Male</option>
                                <option value="female" {% if form.gender.value == "female" %}selected{% endif %}>Female</option>
                            </select>
                            {% if form.gender.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.gender.errors|join:", " }}</p>
                            {% endif %}
                            <p id="id_{{ form.gender.name }}-error-message" class="text-red-500 text-xs mt-1 hidden">Please select your gender.</p>
                        </div>

                        <!-- Logo (Required) -->
                        <div class="relative group">
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0 w-12 h-12 rounded-lg bg-gray-200 flex items-center justify-center overflow-hidden" id="logoPreviewContainer">
                                    <div class="text-gray-400 text-xs text-center" id="logoPlaceholder">No logo selected</div>
                                    <img id="logoPreview" src="" alt="Logo Preview" class="w-full h-full object-contain hidden">
                                </div>
                                <div class="flex-grow">
                                    <label for="id_{{ form.logo.name }}" class="cursor-pointer bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-4 rounded-lg border border-gray-300 inline-flex items-center transition duration-300">
                                        <i class="fas fa-image mr-2"></i>
                                        <span>Choose Logo</span>
                                    </label>
                                    <input type="file" name="{{ form.logo.name }}" id="id_{{ form.logo.name }}" class="hidden" accept="image/*" required>
                                    <p class="text-gray-500 text-xs mt-1">Required. Upload your organization logo.</p>
                                    <p id="id_{{ form.logo.name }}-error-message" class="text-red-500 text-xs mt-1 hidden">Please upload your organization logo.</p>
                                </div>
                            </div>
                            {% if form.logo.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.logo.errors|join:", " }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="relative group">
                    <i class="fas fa-user absolute top-3 left-3 text-gray-400 group-hover:text-tertiary transition-colors duration-300"></i>
                    <input type="text" name="{{ form.username.name }}" id="id_{{ form.username.name }}" class="w-full pl-10 pr-3 py-2 rounded-lg border-2 {% if form.username.errors %}border-red-500{% else %}border-gray-300{% endif %} focus:outline-none focus:border-tertiary transition-all duration-300 bg-gray-50 group-hover:bg-white" placeholder="Username" required>
                    {% if form.username.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.username.errors|join:", " }}</p>
                    {% endif %}
                    <p id="id_{{ form.username.name }}-error-message" class="text-red-500 text-xs mt-1 hidden">Please enter a username.</p>
                    <p class="text-gray-500 text-xs mt-1 username-requirements hidden">Username must be 3-20 characters long and can contain letters, numbers, and underscores.</p>
                </div>
                <div class="relative group">
                    <i class="fas fa-envelope absolute top-3 left-3 text-gray-400 group-hover:text-tertiary transition-colors duration-300"></i>
                    <input type="email" name="{{ form.email.name }}" id="id_{{ form.email.name }}" class="w-full pl-10 pr-3 py-2 rounded-lg border-2 {% if form.email.errors %}border-red-500{% else %}border-gray-300{% endif %} focus:outline-none focus:border-tertiary transition-all duration-300 bg-gray-50 group-hover:bg-white" placeholder="Email" required>
                    {% if form.email.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.email.errors|join:", " }}</p>
                    {% endif %}
                    <p id="id_{{ form.email.name }}-error-message" class="text-red-500 text-xs mt-1 hidden">Please enter a valid email address.</p>
                    <p class="text-gray-500 text-xs mt-1 email-requirements hidden">Please enter a valid email address.</p>
                </div>
                <div class="relative group">
                    <i class="fas fa-lock absolute top-3 left-3 text-gray-400 group-hover:text-tertiary transition-colors duration-300"></i>
                    <div class="relative">
                        <input type="password" name="{{ form.password1.name }}" id="id_{{ form.password1.name }}" class="w-full pl-10 pr-10 py-2 rounded-lg border-2 {% if form.password1.errors %}border-red-500{% else %}border-gray-300{% endif %} focus:outline-none focus:border-tertiary transition-all duration-300 bg-gray-50 group-hover:bg-white" placeholder="Password" required>
                        <button type="button" class="toggle-password absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-tertiary focus:outline-none" data-target="id_{{ form.password1.name }}">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    {% if form.password1.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.password1.errors|join:", " }}</p>
                    {% endif %}
                    <p id="password1-error-message" class="text-red-500 text-xs mt-1 hidden">Please enter a password.</p>
                    <div class="password-strength mt-1 hidden">
                        <div class="flex justify-between mb-1">
                            <span class="text-xs">Password strength:</span>
                            <span class="text-xs font-semibold password-strength-text">Weak</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div class="bg-red-500 h-1.5 rounded-full password-strength-bar" style="width: 10%"></div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-2 gap-y-0">
                            <ul class="text-xs text-gray-500 mt-1 space-y-0.5 password-requirements">
                                <li class="req-length"><i class="fas fa-times-circle text-red-500 mr-1"></i>At least 8 characters</li>
                                <li class="req-uppercase"><i class="fas fa-times-circle text-red-500 mr-1"></i>At least one uppercase letter</li>
                                <li class="req-lowercase"><i class="fas fa-times-circle text-red-500 mr-1"></i>At least one lowercase letter</li>
                            </ul>
                            <ul class="text-xs text-gray-500 mt-1 space-y-0.5">
                                <li class="req-number"><i class="fas fa-times-circle text-red-500 mr-1"></i>At least one number</li>
                                <li class="req-special"><i class="fas fa-times-circle text-red-500 mr-1"></i>At least one special character</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="relative group">
                    <i class="fas fa-lock absolute top-3 left-3 text-gray-400 group-hover:text-tertiary transition-colors duration-300"></i>
                    <div class="relative">
                        <input type="password" name="{{ form.password2.name }}" id="id_{{ form.password2.name }}" class="w-full pl-10 pr-10 py-2 rounded-lg border-2 {% if form.password2.errors %}border-red-500{% else %}border-gray-300{% endif %} focus:outline-none focus:border-tertiary transition-all duration-300 bg-gray-50 group-hover:bg-white" placeholder="Confirm Password" required>
                        <button type="button" class="toggle-password absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-tertiary focus:outline-none" data-target="id_{{ form.password2.name }}">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    {% if form.password2.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.password2.errors|join:", " }}</p>
                    {% endif %}
                    <p id="password2-error-message" class="text-red-500 text-xs mt-1 hidden">Please confirm your password.</p>
                    <p class="text-red-500 text-xs mt-1 password-match-error hidden">Passwords do not match</p>
                </div>
                <div id="register-error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                    <strong class="font-bold">Error! </strong>
                    <span class="block sm:inline message-text"></span>
                </div>
                <button type="submit" id="registerButton" class="w-full bg-tertiary text-white px-4 py-2 rounded-full hover:bg-quaternary transition duration-300 flex items-center justify-center transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-tertiary focus:ring-opacity-50">
                    <span class="spinner hidden inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>
                    <i class="fas fa-user-plus mr-2"></i>
                    <span class="button-text">Register</span>
                </button>
            </form>
            <p class="mt-6 text-center text-gray-600">
                Already have an account? <a href="{% url 'login' %}" class="text-tertiary hover:text-quaternary font-semibold transition-colors duration-300">Login</a>
            </p>
        </div>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>
            $(document).ready(function() {
                // Fetch barangays for Dumingag, Zamboanga del Sur
                fetchBarangays();

                // Handle barangay selection to update the address field
                $('#id_barangay').on('change', function() {
                    updateAddressField();
                });

                function fetchBarangays() {
                    // Show loading state
                    $('#id_barangay').html('<option value="">Loading barangays...</option>');

                    // Try multiple API sources to ensure we get the data
                    // First, try the Philippine Standard Geographic Code (PSGC) API
                    $.ajax({
                        url: 'https://psgc.gitlab.io/api/municipalities/097322000/barangays.json',
                        method: 'GET',
                        dataType: 'json',
                        timeout: 5000, // 5 second timeout
                        success: function(data) {
                            console.log("API 1 Response:", data); // Debug: Log the API response

                            // Check if we have data and it's an array
                            if (data && Array.isArray(data) && data.length > 0) {
                                // Clear loading state
                                $('#id_barangay').html('<option value="">Select Barangay</option>');

                                // Sort barangays alphabetically
                                data.sort(function(a, b) {
                                    return a.name.localeCompare(b.name);
                                });

                                // Add barangays to dropdown
                                $.each(data, function(index, barangay) {
                                    $('#id_barangay').append('<option value="' + barangay.name + '">' + barangay.name + '</option>');
                                });

                                console.log("Loaded " + data.length + " barangays from API 1"); // Debug: Log count
                            } else {
                                console.log("API 1 returned empty or invalid data, trying API 2"); // Debug: Log fallback
                                trySecondApi();
                            }
                        },
                        error: function(xhr, status, error) {
                            console.log("API 1 Error:", status, error); // Debug: Log the error
                            // Try second API
                            trySecondApi();
                        }
                    });
                }

                function trySecondApi() {
                    // Try a second API source
                    console.log("Trying API 2"); // Debug
                    $.ajax({
                        url: 'https://ph-locations-api.buonzz.com/v1/barangays?filter=municipal_code:eq:097322000',
                        method: 'GET',
                        dataType: 'json',
                        timeout: 5000, // 5 second timeout
                        success: function(response) {
                            console.log("API 2 Response:", response); // Debug: Log the API response

                            // Check if we have data
                            if (response && response.data && Array.isArray(response.data) && response.data.length > 0) {
                                // Clear loading state
                                $('#id_barangay').html('<option value="">Select Barangay</option>');

                                // Sort barangays alphabetically
                                response.data.sort(function(a, b) {
                                    return a.name.localeCompare(b.name);
                                });

                                // Add barangays to dropdown
                                $.each(response.data, function(index, barangay) {
                                    $('#id_barangay').append('<option value="' + barangay.name + '">' + barangay.name + '</option>');
                                });

                                console.log("Loaded " + response.data.length + " barangays from API 2"); // Debug: Log count
                            } else {
                                console.log("API 2 returned empty or invalid data, using static list"); // Debug: Log fallback
                                useStaticBarangayList();
                            }
                        },
                        error: function(xhr, status, error) {
                            console.log("API 2 Error:", status, error); // Debug: Log the error
                            // If both APIs fail, use the static list
                            useStaticBarangayList();
                        }
                    });
                }

                function useStaticBarangayList() {
                    // Clear loading state
                    $('#id_barangay').html('<option value="">Select Barangay</option>');

                    console.log("Using static barangay list"); // Debug: Log fallback usage

                    // Complete list of barangays in Dumingag, Zamboanga del Sur
                    const barangays = [
                        "Bagong Kauswagan", "Bagong Silang", "Bagumbayan", "Balonai",
                        "Bitoon", "Blanquita", "Bonifacio", "Bucayan", "Calumanggi",
                        "Canibongan", "Caridad", "Datu Totoca", "Ditulan", "Dulop",
                        "Guitran", "Guling", "Gumpingan", "Labangon", "Licabang",
                        "Lipawan", "Lower Landing", "Lower Timonan", "Macasing",
                        "Mahayahay", "Manuel Iyao", "New Basak", "Ocapan", "Poblacion",
                        "Saad", "San Pablo", "San Pedro", "Sarakan", "Sebucao",
                        "Senote", "Sinonok", "Sunop", "Tagun", "Tamurayan",
                        "Tigbao", "Upper Landing", "Upper Timonan", "San Vicente",
                        "San Miguel", "San Jose", "San Antonio", "San Isidro", "San Roque",
                        "Santa Cruz", "Santa Maria", "Santo Niño", "Santo Rosario",
                        "La Libertad", "La Paz", "Libertad", "Mabuhay", "Magsaysay",
                        "Malasay", "Miatan", "Nilo", "Pag-asa", "Palili", "Pawan",
                        "Rizal", "Roxas", "Salvador", "Salug", "Sinayawan", "Sungayan",
                        "Talaptap", "Tawagan Norte", "Tawagan Sur", "Tuboran", "Zamora",
                        // Additional barangays to ensure completeness
                        "Dapiwak", "Dawan", "Diwan", "Guintananan", "Kapalaran",
                        "Langka", "Lawaan", "Licabang Norte", "Licabang Sur", "Limonan",
                        "Lower Dapiwak", "Lower Salug", "Mahayag", "Malagalad", "Manlabay",
                        "Mauswagon", "New Basak Norte", "New Basak Sur", "New Katipunan",
                        "Pangi", "Purok 1", "Purok 2", "Purok 3", "Purok 4", "Purok 5",
                        "Purok 6", "Purok 7", "Purok 8", "Purok 9", "Purok 10",
                        "San Francisco", "San Juan", "San Luis", "San Rafael", "Santa Ana",
                        "Santa Barbara", "Santa Monica", "Santo Tomas", "Sumalig", "Tabuan",
                        "Upper Dapiwak", "Upper Salug", "Victoria", "Villaflor"
                    ];

                    // Sort barangays alphabetically
                    barangays.sort();

                    // Add barangays to dropdown
                    $.each(barangays, function(index, barangay) {
                        $('#id_barangay').append('<option value="' + barangay + '">' + barangay + '</option>');
                    });

                    console.log("Loaded " + barangays.length + " barangays from static list"); // Debug: Log count
                }

                function updateAddressField() {
                    const province = $('#id_province').val();
                    const municipality = $('#id_municipality').val();
                    const barangay = $('#id_barangay').val();

                    if (barangay) {
                        // Format: Barangay [Name], [Municipality], [Province]
                        const fullAddress = 'Barangay ' + barangay + ', ' + municipality + ', ' + province;
                        $('#id_{{ form.address.name }}').val(fullAddress);
                    } else {
                        $('#id_{{ form.address.name }}').val('');
                    }
                }

                // Image preview handlers
                function readURL(input, previewId, containerId, placeholderId) {
                    if (input.files && input.files[0]) {
                        var reader = new FileReader();

                        reader.onload = function(e) {
                            const preview = $(previewId);
                            preview.attr('src', e.target.result);
                            preview.removeClass('hidden');

                            // Hide placeholder if exists
                            if (placeholderId) {
                                $(placeholderId).addClass('hidden');
                            }
                        }

                        reader.readAsDataURL(input.files[0]);
                    }
                }

                // Profile picture preview
                $('#id_{{ form.profile_picture.name }}').change(function() {
                    readURL(this, '#profilePreview', '#profilePreviewContainer');
                });

                // Logo preview
                $('#id_{{ form.logo.name }}').change(function() {
                    readURL(this, '#logoPreview', '#logoPreviewContainer', '#logoPlaceholder');
                });

                // Show password requirements on focus
                $('#id_{{ form.password1.name }}').on('focus', function() {
                    $('.password-strength').removeClass('hidden');
                });

                // Hide password requirements on blur for mobile
                if (window.innerWidth < 640) {
                    $('#id_{{ form.password1.name }}').on('blur', function() {
                        // Only hide if we're moving to a different field (not just clicking within the field)
                        setTimeout(function() {
                            if (document.activeElement !== document.getElementById('id_{{ form.password1.name }}')) {
                                $('.password-strength').addClass('hidden');
                            }
                        }, 100);
                    });
                }

                // Show username requirements on focus
                $('#id_{{ form.username.name }}').on('focus', function() {
                    $('.username-requirements').removeClass('hidden');
                });

                // Check username availability on blur
                $('#id_{{ form.username.name }}').on('blur', function() {
                    const username = $(this).val().trim();
                    if (username.length > 0) {
                        checkUsernameAvailability(username);
                    }
                });

                // Show email requirements on focus
                $('#id_{{ form.email.name }}').on('focus', function() {
                    $('.email-requirements').removeClass('hidden');
                });

                // Check email availability on blur
                $('#id_{{ form.email.name }}').on('blur', function() {
                    const email = $(this).val().trim();
                    if (email.length > 0 && isValidEmail(email)) {
                        checkEmailAvailability(email);
                    }
                });

                // Function to check username availability
                function checkUsernameAvailability(username) {
                    $.ajax({
                        url: '{% url "check_username_email" %}',
                        data: {
                            'username': username
                        },
                        dataType: 'json',
                        success: function(data) {
                            if (data.is_taken && data.field === 'username') {
                                $('#id_{{ form.username.name }}').addClass('border-red-500').removeClass('border-gray-300');
                                // Check if error message element exists, if not create it
                                let $errorMsg = $('#username-error-message');
                                if ($errorMsg.length === 0) {
                                    $errorMsg = $('<p id="username-error-message" class="text-red-500 text-xs mt-1">' + data.error_message + '</p>');
                                    $('#id_{{ form.username.name }}').parent().append($errorMsg);
                                } else {
                                    $errorMsg.text(data.error_message).removeClass('hidden');
                                }
                            } else {
                                $('#id_{{ form.username.name }}').removeClass('border-red-500').addClass('border-gray-300');
                                $('#username-error-message').addClass('hidden');
                            }
                        }
                    });
                }

                // Function to check email availability
                function checkEmailAvailability(email) {
                    $.ajax({
                        url: '{% url "check_username_email" %}',
                        data: {
                            'email': email
                        },
                        dataType: 'json',
                        success: function(data) {
                            if (data.is_taken && data.field === 'email') {
                                $('#id_{{ form.email.name }}').addClass('border-red-500').removeClass('border-gray-300');
                                // Check if error message element exists, if not create it
                                let $errorMsg = $('#email-error-message');
                                if ($errorMsg.length === 0) {
                                    $errorMsg = $('<p id="email-error-message" class="text-red-500 text-xs mt-1">' + data.error_message + '</p>');
                                    $('#id_{{ form.email.name }}').parent().append($errorMsg);
                                } else {
                                    $errorMsg.text(data.error_message).removeClass('hidden');
                                }
                            } else {
                                $('#id_{{ form.email.name }}').removeClass('border-red-500').addClass('border-gray-300');
                                $('#email-error-message').addClass('hidden');
                            }
                        }
                    });
                }

                // Password strength checker
                $('#id_{{ form.password1.name }}').on('input', function() {
                    const password = $(this).val();
                    let strength = 0;
                    let color = 'red';
                    let text = 'Weak';
                    let width = '20%';

                    // Check requirements
                    const hasLength = password.length >= 8;
                    const hasUppercase = /[A-Z]/.test(password);
                    const hasLowercase = /[a-z]/.test(password);
                    const hasNumber = /[0-9]/.test(password);
                    const hasSpecial = /[^A-Za-z0-9]/.test(password);

                    // Update requirement indicators
                    updateRequirement('length', hasLength);
                    updateRequirement('uppercase', hasUppercase);
                    updateRequirement('lowercase', hasLowercase);
                    updateRequirement('number', hasNumber);
                    updateRequirement('special', hasSpecial);

                    // Calculate strength
                    if (hasLength) strength += 1;
                    if (hasUppercase) strength += 1;
                    if (hasLowercase) strength += 1;
                    if (hasNumber) strength += 1;
                    if (hasSpecial) strength += 1;

                    // Set strength indicator
                    if (strength === 0) {
                        color = 'red';
                        text = 'Very Weak';
                        width = '10%';
                    } else if (strength === 1) {
                        color = 'red';
                        text = 'Weak';
                        width = '20%';
                    } else if (strength === 2) {
                        color = 'orange';
                        text = 'Fair';
                        width = '40%';
                    } else if (strength === 3) {
                        color = 'yellow';
                        text = 'Good';
                        width = '60%';
                    } else if (strength === 4) {
                        color = 'lime';
                        text = 'Strong';
                        width = '80%';
                    } else {
                        color = 'green';
                        text = 'Very Strong';
                        width = '100%';
                    }

                    $('.password-strength-bar').css('width', width).css('background-color', color);
                    $('.password-strength-text').text(text).css('color', color);

                    // Check if passwords match
                    checkPasswordsMatch();
                });

                // Check if passwords match
                $('#id_{{ form.password2.name }}').on('input', function() {
                    checkPasswordsMatch();
                });

                function checkPasswordsMatch() {
                    const password1 = $('#id_{{ form.password1.name }}').val();
                    const password2 = $('#id_{{ form.password2.name }}').val();

                    if (password2 && password1 !== password2) {
                        $('.password-match-error').removeClass('hidden');
                        $('#id_{{ form.password2.name }}').addClass('border-red-500').removeClass('border-gray-300');
                    } else {
                        $('.password-match-error').addClass('hidden');
                        if (!$('#id_{{ form.password2.name }}').hasClass('border-red-500')) {
                            $('#id_{{ form.password2.name }}').removeClass('border-red-500').addClass('border-gray-300');
                        }
                    }
                }

                function updateRequirement(req, isValid) {
                    const $req = $('.req-' + req);
                    if (isValid) {
                        $req.find('i').removeClass('fa-times-circle text-red-500').addClass('fa-check-circle text-green-500');
                    } else {
                        $req.find('i').removeClass('fa-check-circle text-green-500').addClass('fa-times-circle text-red-500');
                    }
                }

                // Form submission with validation
                $('#registerForm').on('submit', function(e) {
                    e.preventDefault();

                    // Basic validation
                    let isValid = true;
                    const registrationCode = $('#id_{{ form.registration_code.name }}').val().trim();
                    const firstName = $('#id_{{ form.first_name.name }}').val().trim();
                    const lastName = $('#id_{{ form.last_name.name }}').val().trim();
                    const dateOfBirth = $('#id_{{ form.date_of_birth.name }}').val().trim();
                    const gender = $('#id_{{ form.gender.name }}').val();
                    console.log('Gender value:', gender); // Debug log
                    const contactNumber = $('#id_{{ form.contact_number.name }}').val().trim();
                    const barangay = $('#id_barangay').val();
                    const address = $('#id_{{ form.address.name }}').val().trim();
                    const termOfOffice = $('#id_{{ form.term_of_office.name }}').val().trim();
                    const logo = $('#id_{{ form.logo.name }}')[0].files[0];
                    const profilePicture = $('#id_{{ form.profile_picture.name }}')[0].files[0];
                    const username = $('#id_{{ form.username.name }}').val().trim();
                    const email = $('#id_{{ form.email.name }}').val().trim();
                    const password1 = $('#id_{{ form.password1.name }}').val();
                    const password2 = $('#id_{{ form.password2.name }}').val();

                    // Registration code validation
                    if (!registrationCode) {
                        $('#id_{{ form.registration_code.name }}').addClass('border-red-500');
                        // Create or update error message
                        let $errorMsg = $('#registration-code-error-message');
                        if ($errorMsg.length === 0) {
                            $errorMsg = $('<p id="registration-code-error-message" class="text-red-500 text-xs mt-1">Please enter a registration code.</p>');
                            $('#id_{{ form.registration_code.name }}').parent().append($errorMsg);
                        } else {
                            $errorMsg.text('Please enter a registration code.').removeClass('hidden');
                        }
                        isValid = false;
                    }

                    // Logo validation
                    if (!logo) {
                        $('#id_{{ form.logo.name }}').closest('.relative.group').find('label').addClass('border-red-500');
                        $('#id_{{ form.logo.name }}-error-message').removeClass('hidden');
                        isValid = false;
                    } else {
                        $('#id_{{ form.logo.name }}').closest('.relative.group').find('label').removeClass('border-red-500');
                        $('#id_{{ form.logo.name }}-error-message').addClass('hidden');
                    }

                    // Profile picture validation
                    if (!profilePicture) {
                        $('#id_{{ form.profile_picture.name }}').closest('.relative.group').find('label').addClass('border-red-500');
                        $('#id_{{ form.profile_picture.name }}-error-message').removeClass('hidden');
                        isValid = false;
                    } else {
                        $('#id_{{ form.profile_picture.name }}').closest('.relative.group').find('label').removeClass('border-red-500');
                        $('#id_{{ form.profile_picture.name }}-error-message').addClass('hidden');
                    }

                    // First name validation
                    if (!firstName) {
                        $('#id_{{ form.first_name.name }}').addClass('border-red-500');
                        // Create or update error message
                        let $errorMsg = $('#first-name-error-message');
                        if ($errorMsg.length === 0) {
                            $errorMsg = $('<p id="first-name-error-message" class="text-red-500 text-xs mt-1">Please enter your first name.</p>');
                            $('#id_{{ form.first_name.name }}').parent().append($errorMsg);
                        } else {
                            $errorMsg.text('Please enter your first name.').removeClass('hidden');
                        }
                        isValid = false;
                    }

                    // Last name validation
                    if (!lastName) {
                        $('#id_{{ form.last_name.name }}').addClass('border-red-500');
                        // Create or update error message
                        let $errorMsg = $('#last-name-error-message');
                        if ($errorMsg.length === 0) {
                            $errorMsg = $('<p id="last-name-error-message" class="text-red-500 text-xs mt-1">Please enter your last name.</p>');
                            $('#id_{{ form.last_name.name }}').parent().append($errorMsg);
                        } else {
                            $errorMsg.text('Please enter your last name.').removeClass('hidden');
                        }
                        isValid = false;
                    }

                    // Date of birth validation
                    if (!dateOfBirth) {
                        $('#id_{{ form.date_of_birth.name }}').addClass('border-red-500');
                        // Create or update error message
                        let $errorMsg = $('#date-of-birth-error-message');
                        if ($errorMsg.length === 0) {
                            $errorMsg = $('<p id="date-of-birth-error-message" class="text-red-500 text-xs mt-1">Please enter your date of birth.</p>');
                            $('#id_{{ form.date_of_birth.name }}').parent().append($errorMsg);
                        } else {
                            $errorMsg.text('Please enter your date of birth.').removeClass('hidden');
                        }
                        isValid = false;
                    }

                    // Gender validation
                    if (!gender) {
                        $('#id_{{ form.gender.name }}').addClass('border-red-500');
                        // Create or update error message
                        let $errorMsg = $('#id_{{ form.gender.name }}-error-message');
                        if ($errorMsg.length === 0) {
                            $errorMsg = $('<p id="id_{{ form.gender.name }}-error-message" class="text-red-500 text-xs mt-1">Please select your gender.</p>');
                            $('#id_{{ form.gender.name }}').parent().append($errorMsg);
                        } else {
                            $errorMsg.removeClass('hidden');
                        }
                        isValid = false;
                    } else {
                        $('#id_{{ form.gender.name }}').removeClass('border-red-500');
                        $('#id_{{ form.gender.name }}-error-message').addClass('hidden');
                    }

                    // Contact Number validation
                    if (!contactNumber) {
                        $('#id_{{ form.contact_number.name }}').addClass('border-red-500');
                        // Create or update error message
                        let $errorMsg = $('#contact-number-error-message');
                        if ($errorMsg.length === 0) {
                            $errorMsg = $('<p id="contact-number-error-message" class="text-red-500 text-xs mt-1">Please enter your contact number.</p>');
                            $('#id_{{ form.contact_number.name }}').parent().append($errorMsg);
                        } else {
                            $errorMsg.text('Please enter your contact number.').removeClass('hidden');
                        }
                        isValid = false;
                    }

                    // Barangay validation
                    if (!barangay) {
                        $('#id_barangay').addClass('border-red-500');
                        // Create or update error message
                        let $errorMsg = $('#barangay-error-message');
                        if ($errorMsg.length === 0) {
                            $errorMsg = $('<p id="barangay-error-message" class="text-red-500 text-xs mt-1">Please select your barangay.</p>');
                            $('#id_barangay').parent().parent().parent().append($errorMsg);
                        } else {
                            $errorMsg.text('Please select your barangay.').removeClass('hidden');
                        }
                        isValid = false;
                    } else {
                        // Make sure the address field is updated
                        updateAddressField();
                    }

                    // Term of Office validation
                    if (!termOfOffice) {
                        $('#id_{{ form.term_of_office.name }}').addClass('border-red-500');
                        // Create or update error message
                        let $errorMsg = $('#term-of-office-error-message');
                        if ($errorMsg.length === 0) {
                            $errorMsg = $('<p id="term-of-office-error-message" class="text-red-500 text-xs mt-1">Please enter your term of office.</p>');
                            $('#id_{{ form.term_of_office.name }}').parent().append($errorMsg);
                        } else {
                            $errorMsg.text('Please enter your term of office.').removeClass('hidden');
                        }
                        isValid = false;
                    }

                    // Logo validation (required)
                    if (!logo) {
                        $('#id_{{ form.logo.name }}').parent().parent().parent().addClass('border-red-500');
                        // Create or update error message
                        let $errorMsg = $('#id_{{ form.logo.name }}-error-message');
                        if ($errorMsg.length === 0) {
                            $errorMsg = $('<p id="id_{{ form.logo.name }}-error-message" class="text-red-500 text-xs mt-1">Please upload your organization logo.</p>');
                            $('#id_{{ form.logo.name }}').parent().parent().append($errorMsg);
                        } else {
                            $errorMsg.removeClass('hidden');
                        }
                        isValid = false;
                    } else {
                        $('#id_{{ form.logo.name }}-error-message').addClass('hidden');
                    }

                    // Profile Picture validation (required)
                    if (!profilePicture) {
                        $('#id_{{ form.profile_picture.name }}').parent().parent().parent().addClass('border-red-500');
                        // Create or update error message
                        let $errorMsg = $('#id_{{ form.profile_picture.name }}-error-message');
                        if ($errorMsg.length === 0) {
                            $errorMsg = $('<p id="id_{{ form.profile_picture.name }}-error-message" class="text-red-500 text-xs mt-1">Please upload your profile picture.</p>');
                            $('#id_{{ form.profile_picture.name }}').parent().parent().append($errorMsg);
                        } else {
                            $errorMsg.removeClass('hidden');
                        }
                        isValid = false;
                    } else {
                        $('#id_{{ form.profile_picture.name }}-error-message').addClass('hidden');
                    }

                    // Username validation
                    if (!username) {
                        $('#id_{{ form.username.name }}').addClass('border-red-500');
                        isValid = false;
                    } else if ($('#username-error-message').length > 0 && !$('#username-error-message').hasClass('hidden')) {
                        // Username is taken
                        isValid = false;
                    }

                    // Email validation
                    if (!email || !isValidEmail(email)) {
                        $('#id_{{ form.email.name }}').addClass('border-red-500');
                        if (!email) {
                            // Create or update error message
                            let $errorMsg = $('#email-error-message');
                            if ($errorMsg.length === 0) {
                                $errorMsg = $('<p id="email-error-message" class="text-red-500 text-xs mt-1">Please enter your email address.</p>');
                                $('#id_{{ form.email.name }}').parent().append($errorMsg);
                            } else {
                                $errorMsg.text('Please enter your email address.').removeClass('hidden');
                            }
                        } else {
                            // Create or update error message for invalid email
                            let $errorMsg = $('#email-error-message');
                            if ($errorMsg.length === 0) {
                                $errorMsg = $('<p id="email-error-message" class="text-red-500 text-xs mt-1">Please enter a valid email address.</p>');
                                $('#id_{{ form.email.name }}').parent().append($errorMsg);
                            } else {
                                $errorMsg.text('Please enter a valid email address.').removeClass('hidden');
                            }
                        }
                        isValid = false;
                    } else if ($('#email-error-message').length > 0 && !$('#email-error-message').hasClass('hidden')) {
                        // Email is taken
                        isValid = false;
                    }

                    // Password validation
                    if (!password1 || password1.length < 8) {
                        $('#id_{{ form.password1.name }}').addClass('border-red-500');
                        isValid = false;
                    }

                    // Confirm password validation
                    if (!password2 || password1 !== password2) {
                        $('#id_{{ form.password2.name }}').addClass('border-red-500');
                        $('.password-match-error').removeClass('hidden');
                        isValid = false;
                    }

                    if (!isValid) {
                        $('#register-error-message').removeClass('hidden bg-green-100 border-green-400 text-green-700')
                            .addClass('bg-red-100 border-red-400 text-red-700');
                        $('#register-error-message strong').text('Error! ');
                        $('#register-error-message .message-text').text('Please fix the errors in the form.');

                        // Scroll to the first error - prioritize logo and profile picture
                        if (!logo) {
                            $('html, body').animate({
                                scrollTop: $('#id_{{ form.logo.name }}').closest('.relative.group').offset().top - 100
                            }, 500);
                        } else if (!profilePicture) {
                            $('html, body').animate({
                                scrollTop: $('#id_{{ form.profile_picture.name }}').closest('.relative.group').offset().top - 100
                            }, 500);
                        } else if (window.innerWidth < 640) {
                            setTimeout(function() {
                                document.getElementById('registerButton').scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }, 100);
                        }
                        return;
                    }

                    // Check username and email availability before submitting
                    $.when(
                        $.ajax({
                            url: '{% url "check_username_email" %}',
                            data: { 'username': username },
                            dataType: 'json'
                        }),
                        $.ajax({
                            url: '{% url "check_username_email" %}',
                            data: { 'email': email },
                            dataType: 'json'
                        })
                    ).done(function(usernameResponse, emailResponse) {
                        const usernameData = usernameResponse[0];
                        const emailData = emailResponse[0];

                        if (usernameData.is_taken) {
                            $('#id_{{ form.username.name }}').addClass('border-red-500').removeClass('border-gray-300');
                            let $errorMsg = $('#username-error-message');
                            if ($errorMsg.length === 0) {
                                $errorMsg = $('<p id="username-error-message" class="text-red-500 text-xs mt-1">' + usernameData.error_message + '</p>');
                                $('#id_{{ form.username.name }}').parent().append($errorMsg);
                            } else {
                                $errorMsg.text(usernameData.error_message).removeClass('hidden');
                            }

                            $('#register-error-message').removeClass('hidden bg-green-100 border-green-400 text-green-700')
                                .addClass('bg-red-100 border-red-400 text-red-700');
                            $('#register-error-message strong').text('Error! ');
                            $('#register-error-message .message-text').text('Please fix the errors in the form.');

                            // Scroll to the error message or register button on mobile
                            if (window.innerWidth < 640) {
                                setTimeout(function() {
                                    document.getElementById('registerButton').scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }, 100);
                            }
                            return;
                        }

                        if (emailData.is_taken) {
                            $('#id_{{ form.email.name }}').addClass('border-red-500').removeClass('border-gray-300');
                            let $errorMsg = $('#email-error-message');
                            if ($errorMsg.length === 0) {
                                $errorMsg = $('<p id="email-error-message" class="text-red-500 text-xs mt-1">' + emailData.error_message + '</p>');
                                $('#id_{{ form.email.name }}').parent().append($errorMsg);
                            } else {
                                $errorMsg.text(emailData.error_message).removeClass('hidden');
                            }

                            $('#register-error-message').removeClass('hidden bg-green-100 border-green-400 text-green-700')
                                .addClass('bg-red-100 border-red-400 text-red-700');
                            $('#register-error-message strong').text('Error! ');
                            $('#register-error-message .message-text').text('Please fix the errors in the form.');

                            // Scroll to the error message or register button on mobile
                            if (window.innerWidth < 640) {
                                setTimeout(function() {
                                    document.getElementById('registerButton').scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }, 100);
                            }
                            return;
                        }

                        // If we get here, both username and email are available

                        // Show loading state
                        const $button = $('#registerButton');
                        const $spinner = $button.find('.spinner');
                        const $icon = $button.find('i');
                        const $text = $button.find('.button-text');

                        $button.prop('disabled', true);
                        $spinner.removeClass('hidden');
                        $icon.addClass('hidden');
                        $text.text('Registering...');

                        // Get CSRF token
                        const csrftoken = $('input[name="csrfmiddlewaretoken"]').val();

                        // Submit the form via AJAX with file uploads
                        var formData = new FormData($('#registerForm')[0]);

                        // Debug log for gender value
                        console.log('Gender value in FormData:', formData.get('gender'));

                        $.ajax({
                            type: 'POST',
                            url: '{% url "register" %}',
                            data: formData,
                            processData: false,
                            contentType: false,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'X-CSRFToken': csrftoken
                            },
                            success: function(response) {
                                if (response.success) {
                                    // Show success message
                                    $('#register-error-message').removeClass('hidden bg-red-100 border-red-400 text-red-700')
                                        .addClass('bg-green-100 border-green-400 text-green-700');
                                    $('#register-error-message strong').text('Success! ');
                                    $('#register-error-message .message-text').text(response.message || 'Registration successful!');

                                    // Redirect after a short delay
                                    setTimeout(function() {
                                        window.location.href = response.redirect_url || '{% url "login" %}';
                                    }, 2000);
                                } else {
                                    // Show error message
                                    $('#register-error-message').removeClass('hidden bg-green-100 border-green-400 text-green-700')
                                        .addClass('bg-red-100 border-red-400 text-red-700');
                                    $('#register-error-message strong').text('Error! ');
                                    $('#register-error-message .message-text').text(response.error || 'Registration failed. Please try again.');

                                    // Display field-specific errors if available
                                    if (response.errors) {
                                        for (const field in response.errors) {
                                            const fieldId = '#id_' + field;
                                            $(fieldId).addClass('border-red-500');

                                            // Find or create error message element
                                            let $errorMsg = $(fieldId + '-error-message');
                                            if ($errorMsg.length === 0) {
                                                $errorMsg = $('<p id="' + fieldId.substring(1) + '-error-message" class="text-red-500 text-xs mt-1">' + response.errors[field].join(', ') + '</p>');
                                                $(fieldId).parent().append($errorMsg);
                                            } else {
                                                $errorMsg.text(response.errors[field].join(', ')).removeClass('hidden');
                                            }
                                        }
                                    }

                                    // Reset button state
                                    $button.prop('disabled', false);
                                    $spinner.addClass('hidden');
                                    $icon.removeClass('hidden');
                                    $text.text('Register');

                                    // Scroll to the error message or register button on mobile
                                    if (window.innerWidth < 640) {
                                        setTimeout(function() {
                                            document.getElementById('registerButton').scrollIntoView({ behavior: 'smooth', block: 'center' });
                                        }, 100);
                                    }
                                }
                            },
                            error: function() {
                                // Show generic error message
                                $('#register-error-message').removeClass('hidden bg-green-100 border-green-400 text-green-700')
                                    .addClass('bg-red-100 border-red-400 text-red-700');
                                $('#register-error-message strong').text('Error! ');
                                $('#register-error-message .message-text').text('An error occurred. Please try again.');

                                // Reset button state
                                $button.prop('disabled', false);
                                $spinner.addClass('hidden');
                                $icon.removeClass('hidden');
                                $text.text('Register');

                                // Scroll to the error message or register button on mobile
                                if (window.innerWidth < 640) {
                                    setTimeout(function() {
                                        document.getElementById('registerButton').scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    }, 100);
                                }
                            }
                        });
                    });
                });

                function isValidEmail(email) {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    return emailRegex.test(email);
                }

                // Password toggle functionality
                $('.toggle-password').on('click', function() {
                    const targetId = $(this).data('target');
                    const passwordInput = $('#' + targetId);
                    const icon = $(this).find('i');

                    // Toggle password visibility
                    if (passwordInput.attr('type') === 'password') {
                        passwordInput.attr('type', 'text');
                        icon.removeClass('fa-eye').addClass('fa-eye-slash');
                    } else {
                        passwordInput.attr('type', 'password');
                        icon.removeClass('fa-eye-slash').addClass('fa-eye');
                    }
                });

                // Add input validation for all required fields
                $('input[required], select[required]').on('blur', function() {
                    const fieldId = $(this).attr('id');
                    const fieldValue = $(this).val().trim();
                    const isFileInput = $(this).attr('type') === 'file';

                    if (isFileInput) {
                        // For file inputs, check if files are selected
                        if (!this.files || this.files.length === 0) {
                            $(this).closest('.relative.group').find('label').addClass('border-red-500');
                            const errorMsgId = '#' + fieldId + '-error-message';
                            $(errorMsgId).removeClass('hidden');
                        } else {
                            $(this).closest('.relative.group').find('label').removeClass('border-red-500');
                            const errorMsgId = '#' + fieldId + '-error-message';
                            $(errorMsgId).addClass('hidden');
                        }
                    } else {
                        // For regular inputs
                        if (!fieldValue) {
                            $(this).addClass('border-red-500').removeClass('border-gray-300');
                            const errorMsgId = '#' + fieldId + '-error-message';
                            $(errorMsgId).removeClass('hidden');
                        } else {
                            $(this).removeClass('border-red-500').addClass('border-gray-300');
                            const errorMsgId = '#' + fieldId + '-error-message';
                            $(errorMsgId).addClass('hidden');
                        }
                    }
                });
            });
        </script>
    </body>
</html>
