{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block content %}
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
        <h1 class="text-3xl font-bold text-tertiary">
            <i class="fas fa-tachometer-alt mr-2"></i>Admin Dashboard
        </h1>

    </div>

<!-- Enhanced global search form with advanced filters -->
    <form method="get" class="mb-6">
        <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-tertiary">
            <h3 class="text-lg font-semibold mb-3 text-tertiary"><i class="fas fa-search mr-2"></i>Advanced Search</h3>

            <!-- Basic search -->
            <div class="flex flex-col sm:flex-row mb-4">
                <input type="text" name="search" value="{{ search_query }}" placeholder="Search chairmen, projects, budgets..."
                    class="flex-grow p-2 border rounded-lg sm:rounded-l-lg sm:rounded-r-none mb-2 sm:mb-0 focus:ring-2 focus:ring-tertiary focus:outline-none">
                <button type="submit" class="bg-tertiary text-white px-4 py-2 rounded-lg sm:rounded-l-none sm:rounded-r-lg hover:bg-quaternary transition duration-300">
                    <i class="fas fa-search mr-2"></i>Search
                </button>
            </div>

            <!-- Advanced filters - collapsible -->
            <div class="mb-2">
                <button type="button" id="toggleAdvancedSearch" class="text-tertiary hover:text-quaternary transition duration-300 text-sm flex items-center">
                    <i class="fas fa-filter mr-1"></i> Advanced Filters
                    <i class="fas fa-chevron-down ml-1 transition-transform duration-300" id="filterChevron"></i>
                </button>
            </div>

            <div id="advancedSearchOptions" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                    <!-- Date range filters -->
                    <div class="flex flex-col">
                        <label for="date_from" class="text-sm text-gray-600 mb-1">From Date:</label>
                        <input type="date" id="date_from" name="date_from" value="{{ date_from }}"
                            class="p-2 border rounded-lg focus:ring-2 focus:ring-tertiary focus:outline-none">
                    </div>

                    <div class="flex flex-col">
                        <label for="date_to" class="text-sm text-gray-600 mb-1">To Date:</label>
                        <input type="date" id="date_to" name="date_to" value="{{ date_to }}"
                            class="p-2 border rounded-lg focus:ring-2 focus:ring-tertiary focus:outline-none">
                    </div>

                    <!-- Status filter -->
                    <div class="flex flex-col">
                        <label for="status" class="text-sm text-gray-600 mb-1">Project Status:</label>
                        <select id="status" name="status"
                            class="p-2 border rounded-lg focus:ring-2 focus:ring-tertiary focus:outline-none">
                            <option value="">All Statuses</option>
                            <option value="completed" {% if status == 'completed' %}selected{% endif %}>Completed</option>
                            <option value="in_progress" {% if status == 'in_progress' %}selected{% endif %}>In Progress</option>
                            <option value="not_started" {% if status == 'not_started' %}selected{% endif %}>Not Started</option>
                        </select>
                    </div>

                    <!-- Budget range filters -->
                    <div class="flex flex-col">
                        <label for="min_budget" class="text-sm text-gray-600 mb-1">Min Budget (₱):</label>
                        <input type="number" id="min_budget" name="min_budget" value="{{ min_budget }}" placeholder="0"
                            class="p-2 border rounded-lg focus:ring-2 focus:ring-tertiary focus:outline-none">
                    </div>

                    <div class="flex flex-col">
                        <label for="max_budget" class="text-sm text-gray-600 mb-1">Max Budget (₱):</label>
                        <input type="number" id="max_budget" name="max_budget" value="{{ max_budget }}" placeholder="1000000"
                            class="p-2 border rounded-lg focus:ring-2 focus:ring-tertiary focus:outline-none">
                    </div>

                    <!-- Year filter -->
                    <div class="flex flex-col">
                        <label for="year" class="text-sm text-gray-600 mb-1">Budget Year:</label>
                        <select id="year" name="year"
                            class="p-2 border rounded-lg focus:ring-2 focus:ring-tertiary focus:outline-none">
                            <option value="">All Years</option>
                            {% for year_option in available_years %}
                                <option value="{{ year_option }}" {% if selected_year == year_option|stringformat:"i" %}selected{% endif %}>{{ year_option }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="flex justify-end space-x-2">
                    <button type="reset" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-300">
                        <i class="fas fa-undo mr-1"></i>Reset
                    </button>
                    <button type="submit" class="px-4 py-2 bg-tertiary text-white rounded-lg hover:bg-quaternary transition duration-300">
                        <i class="fas fa-filter mr-1"></i>Apply Filters
                    </button>
                </div>
            </div>

            {% if search_applied %}
            <div class="mt-4 pt-3 border-t border-gray-200">
                <div class="flex justify-between items-center">
                    <p class="text-sm text-gray-600">
                        <i class="fas fa-info-circle mr-1"></i>
                        Found <span class="font-semibold">{{ results_count }}</span> results
                    </p>
                    <a href="{% url 'admin_dashboard' %}" class="text-sm text-tertiary hover:text-quaternary transition duration-300">
                        <i class="fas fa-times-circle mr-1"></i>Clear all filters
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </form>

    <div class="mb-8">
        <h2 class="text-2xl font-semibold mb-4 text-tertiary"><i class="fas fa-chart-pie mr-2"></i>Overall Budget Summary</h2>
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-tertiary">
            <p class="flex items-center mb-2"><i class="fas fa-money-bill-wave text-quaternary mr-2"></i>Total Budget: <span class="ml-2 font-semibold">₱{{ total_budget|intcomma }}</span></p>
            <p class="flex items-center mb-2"><i class="fas fa-receipt text-quaternary mr-2"></i>Total Expenses: <span class="ml-2 font-semibold">₱{{ total_expenses|intcomma }}</span></p>
            <p class="flex items-center"><i class="fas fa-piggy-bank text-quaternary mr-2"></i>Remaining Budget: <span class="ml-2 font-semibold">₱{{ total_budget|sub:total_expenses|intcomma }}</span></p>
        </div>
    </div>

    <div class="mb-8">
        <h2 class="text-2xl font-semibold mb-4 text-tertiary"><i class="fas fa-list-alt mr-2"></i>All Main Budgets</h2>
        <div class="mb-4 bg-white rounded-lg shadow-md p-4">
            <div class="flex flex-col md:flex-row md:items-center md:space-x-4">
                <div class="flex-grow mb-3 md:mb-0">
                    <div class="relative">
                        <input type="text" id="budgetSearch" placeholder="Search by year, chairman, address..."
                            class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-tertiary">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <select id="budgetYearFilter" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-tertiary">
                        <option value="">All Years</option>
                        {% for year_option in available_years %}
                            <option value="{{ year_option }}">{{ year_option }}</option>
                        {% endfor %}
                    </select>
                    <button id="resetBudgetFilters" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-300">
                        <i class="fas fa-undo mr-1"></i>Reset
                    </button>
                </div>
            </div>
        </div>
        <div class="overflow-x-auto bg-white rounded-lg shadow-md">
            <div class="p-4 md:hidden">
                <p class="text-sm text-gray-500">Swipe horizontally to view all budget details</p>
            </div>
            <table id="mainBudgetsTable" class="min-w-full">
                <thead class="bg-tertiary text-white">
                    <tr>
                        <th class="py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base"><i class="far fa-calendar-alt mr-1 sm:mr-2"></i>Year</th>
                        <th class="py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base"><i class="fas fa-user-tie mr-1 sm:mr-2"></i>Chairman</th>
                        <th class="py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base hidden md:table-cell"><i class="fas fa-map-marker-alt mr-1 sm:mr-2"></i>Address</th>
                        <th class="py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base"><i class="fas fa-money-bill-alt mr-1 sm:mr-2"></i>Total Budget</th>
                        <th class="py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base hidden sm:table-cell"><i class="fas fa-chart-bar mr-1 sm:mr-2"></i>Allocated</th>
                        <th class="py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base"><i class="fas fa-coins mr-1 sm:mr-2"></i>Remaining</th>
                    </tr>
                </thead>
                <tbody>
                    {% for budget in all_main_budgets %}
                        <tr class="hover:bg-secondary">
                            <td class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base">{{ budget.year }}</td>
                            <td class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base">{{ budget.chairman.get_full_name|title }}</td>
                            <td class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base hidden md:table-cell">{{ budget.chairman.address|default:"N/A" }}</td>
                            <td class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base">₱{{ budget.total_budget|intcomma }}</td>
                            <td class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base hidden sm:table-cell">₱{{ budget.allocated_budget|intcomma }}</td>
                            <td class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base">₱{{ budget.remaining_budget|intcomma }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="bg-gray-100 font-semibold">
                    <tr>
                        <td class="py-2 sm:py-3 px-2 sm:px-4 border-t text-xs sm:text-sm md:text-base" colspan="3">Totals:</td>
                        <td class="py-2 sm:py-3 px-2 sm:px-4 border-t text-xs sm:text-sm md:text-base" id="totalBudgetSum">₱0</td>
                        <td class="py-2 sm:py-3 px-2 sm:px-4 border-t text-xs sm:text-sm md:text-base hidden sm:table-cell" id="allocatedBudgetSum">₱0</td>
                        <td class="py-2 sm:py-3 px-2 sm:px-4 border-t text-xs sm:text-sm md:text-base" id="remainingBudgetSum">₱0</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <div class="mb-8">
        <h2 class="text-2xl font-semibold mb-4 text-tertiary"><i class="fas fa-project-diagram mr-2"></i>All Projects</h2>
        <div class="mb-4 bg-white rounded-lg shadow-md p-4">
            <div class="flex flex-col md:flex-row md:items-center md:space-x-4">
                <div class="flex-grow mb-3 md:mb-0">
                    <div class="relative">
                        <input type="text" id="projectSearch" placeholder="Search by name, chairman, status..."
                            class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-tertiary">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:flex md:space-x-2 gap-2 md:gap-0">
                    <select id="projectStatusFilter" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-tertiary">
                        <option value="">All Statuses</option>
                        <option value="completed">Completed</option>
                        <option value="in-progress">In Progress</option>
                        <option value="not-started">Not Started</option>
                        <option value="ended">Ended</option>
                    </select>
                    <select id="projectBudgetFilter" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-tertiary">
                        <option value="">All Budgets</option>
                        <option value="low">Low (< ₱50,000)</option>
                        <option value="medium">Medium (₱50,000 - ₱200,000)</option>
                        <option value="high">High (> ₱200,000)</option>
                    </select>
                    <button id="resetProjectFilters" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-300 col-span-2 md:col-span-1">
                        <i class="fas fa-undo mr-1"></i>Reset
                    </button>
                </div>
            </div>
        </div>
        <div class="overflow-x-auto bg-white rounded-lg shadow-md">
            <div class="p-4 md:hidden">
                <p class="text-sm text-gray-500">Swipe horizontally to view all project details</p>
            </div>
            <table id="projectsTable" class="min-w-full">
                <thead class="bg-tertiary text-white">
                    <tr>
                        <th class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base"><i class="fas fa-folder mr-1 sm:mr-2"></i>Name</th>
                        <th class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base hidden sm:table-cell"><i class="fas fa-user-tie mr-1 sm:mr-2"></i>Chairman</th>
                        <th class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base"><i class="fas fa-money-bill-alt mr-1 sm:mr-2"></i>Budget</th>
                        <th class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base hidden md:table-cell"><i class="fas fa-calendar-plus mr-1 sm:mr-2"></i>Start Date</th>
                        <th class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base hidden md:table-cell"><i class="fas fa-calendar-check mr-1 sm:mr-2"></i>End Date</th>
                        <th class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base"><i class="fas fa-info-circle mr-1 sm:mr-2"></i>Status</th>
                        <th class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base hidden sm:table-cell"><i class="fas fa-chart-line mr-1 sm:mr-2"></i>Progress</th>
                        <th class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base"><i class="fas fa-cogs mr-1 sm:mr-2"></i>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for project in all_projects %}
                        <tr class="hover:bg-secondary">
                            <td class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base">{{ project.name|title }}</td>
                            <td class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base hidden sm:table-cell">{{ project.chairman.get_full_name|title }}</td>
                            <td class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base">₱{{ project.allocated_budget|intcomma }}</td>
                            <td class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base hidden md:table-cell">{{ project.start_date|date:"M d, Y" }}</td>
                            <td class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base hidden md:table-cell">{{ project.end_date|date:"M d, Y" }}</td>
                            <td class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base">
                                {% now "Y-m-d" as current_date %}
                                {% if project.status == 'completed' %}
                                    <span class="inline-flex items-center px-1.5 sm:px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <i class="fas fa-check-circle mr-1"></i>Completed
                                    </span>
                                    <div class="mt-1 hidden sm:block">
                                        <span class="text-xs text-gray-600 font-medium">
                                            <i class="fas fa-trophy text-yellow-500 mr-1"></i>Verified
                                        </span>
                                    </div>
                                {% elif project.end_date|date:"Y-m-d" < current_date %}
                                    <span class="inline-flex items-center px-1.5 sm:px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                        <i class="fas fa-hourglass-end mr-1"></i>Ended
                                    </span>
                                    <div class="mt-1 hidden sm:block">
                                        <span class="text-xs text-orange-500">
                                            <i class="fas fa-exclamation-triangle mr-1"></i>Needs verification
                                        </span>
                                    </div>
                                {% elif project.start_date|date:"Y-m-d" <= current_date and project.end_date|date:"Y-m-d" >= current_date %}
                                    <span class="inline-flex items-center px-1.5 sm:px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        <i class="fas fa-spinner mr-1 fa-spin"></i>In Progress
                                    </span>
                                {% elif project.start_date|date:"Y-m-d" > current_date %}
                                    <span class="inline-flex items-center px-1.5 sm:px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                        <i class="fas fa-clock mr-1"></i>Not Started
                                    </span>
                                {% endif %}
                            </td>
                            <td class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base hidden sm:table-cell">
                                {% with total_expenses=project.expenses.all|sum_expenses %}
                                    <div class="flex flex-col space-y-2">
                                        <!-- Budget Status -->
                                        {% if project.status == 'completed' %}
                                            <span class="inline-flex items-center px-1.5 sm:px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                <i class="fas fa-flag-checkered mr-1"></i>Completed
                                            </span>
                                        {% elif total_expenses >= project.allocated_budget %}
                                            <span class="inline-flex items-center px-1.5 sm:px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                <i class="fas fa-exclamation-circle mr-1"></i>Over Budget
                                            </span>
                                        {% elif total_expenses >= project.allocated_budget|multiply:0.8 %}
                                            <span class="inline-flex items-center px-1.5 sm:px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                                <i class="fas fa-exclamation-triangle mr-1"></i>Near Limit
                                            </span>
                                        {% else %}
                                            <span class="inline-flex items-center px-1.5 sm:px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                <i class="fas fa-check mr-1"></i>Within Budget
                                            </span>
                                        {% endif %}

                                        <!-- Progress Bar -->
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            {% if project.status == 'completed' %}
                                                <div class="h-2 rounded-full bg-green-500" style="width: 100%"></div>
                                            {% else %}
                                                <div class="h-2 rounded-full {% if total_expenses >= project.allocated_budget %}bg-red-500{% elif total_expenses >= project.allocated_budget|multiply:0.8 %}bg-yellow-500{% else %}bg-green-500{% endif %}"
                                                     style="width: {{ total_expenses|percentage:project.allocated_budget }}%">
                                                </div>
                                            {% endif %}
                                        </div>

                                        <!-- Progress Text -->
                                        {% if project.status == 'completed' %}
                                            <span class="text-xs text-gray-600">100% complete</span>
                                        {% else %}
                                            <span class="text-xs text-gray-600">{{ total_expenses|percentage:project.allocated_budget }}% used</span>
                                        {% endif %}
                                    </div>
                                {% endwith %}
                            </td>
                            <td class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base">
                                <div class="flex flex-col space-y-2">
                                    <a href="{% url 'project_detail' project.id %}"
                                       class="inline-flex items-center px-2 sm:px-3 py-1 bg-tertiary text-white rounded hover:bg-quaternary transition duration-300 text-xs sm:text-sm">
                                        <i class="fas fa-eye mr-1"></i>
                                        <span class="hidden xs:inline">View</span> Details
                                    </a>

                                    {% if project.status == 'completed' %}
                                    <a href="{% url 'project_accomplishment_report' project.id %}"
                                       class="inline-flex items-center px-2 sm:px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition duration-300 text-xs sm:text-sm">
                                        <i class="fas fa-file-alt mr-1"></i>
                                        <span class="hidden xs:inline">View</span> Reports
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="bg-gray-100 font-semibold">
                    <tr>
                        <td class="py-2 sm:py-3 px-2 sm:px-4 border-t text-xs sm:text-sm md:text-base" colspan="2">Totals:</td>
                        <td class="py-2 sm:py-3 px-2 sm:px-4 border-t text-xs sm:text-sm md:text-base" id="totalProjectBudget">₱0</td>
                        <td class="py-2 sm:py-3 px-2 sm:px-4 border-t text-xs sm:text-sm md:text-base" colspan="5"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <div class="mb-8">
        <h2 class="text-2xl font-semibold mb-4 text-tertiary"><i class="fas fa-user-check mr-2"></i>Users Pending Approval</h2>
        <div class="mb-4 bg-white rounded-lg shadow-md p-4">
            <div class="relative">
                <input type="text" id="pendingUserSearch" placeholder="Search by username, email..."
                    class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-tertiary">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-search text-gray-400"></i>
                </div>
            </div>
        </div>
        <div class="overflow-x-auto bg-white rounded-lg shadow-md">
            <div class="p-4 md:hidden">
                <p class="text-sm text-gray-500">Swipe horizontally to view all user details</p>
            </div>
            <table id="pendingUsersTable" class="min-w-full">
                <thead class="bg-tertiary text-white">
                    <tr>
                        <th class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base"><i class="fas fa-user mr-1 sm:mr-2"></i>Username</th>
                        <th class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base hidden sm:table-cell"><i class="fas fa-envelope mr-1 sm:mr-2"></i>Email</th>
                        <th class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base hidden md:table-cell"><i class="fas fa-calendar-alt mr-1 sm:mr-2"></i>Date Joined</th>
                        <th class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base"><i class="fas fa-cogs mr-1 sm:mr-2"></i>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in pending_users %}
                        <tr class="hover:bg-secondary">
                            <td class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base">{{ user.username }}</td>
                            <td class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base hidden sm:table-cell">{{ user.email }}</td>
                            <td class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base hidden md:table-cell">{{ user.date_joined|date:"M d, Y" }}</td>
                            <td class="py-2 sm:py-3 px-2 sm:px-4 border-b text-xs sm:text-sm md:text-base">
                                <div class="flex flex-col xs:flex-row space-y-2 xs:space-y-0 xs:space-x-2">
                                    <form method="post" action="{% url 'approve_user' user.id %}" class="inline">
                                        {% csrf_token %}
                                        <button type="submit" class="inline-flex items-center px-2 sm:px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 transition duration-300 text-xs sm:text-sm w-full xs:w-auto justify-center">
                                            <i class="fas fa-check mr-1"></i>Approve
                                        </button>
                                    </form>
                                    <form method="post" action="{% url 'reject_user' user.id %}" class="inline">
                                        {% csrf_token %}
                                        <button type="submit" class="inline-flex items-center px-2 sm:px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition duration-300 text-xs sm:text-sm w-full xs:w-auto justify-center">
                                            <i class="fas fa-times mr-1"></i>Reject
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="4" class="py-4 px-4 text-center text-gray-500">No users pending approval.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="mb-8">
        <h2 class="text-2xl font-semibold mb-4 text-tertiary"><i class="fas fa-trophy mr-2"></i>Completed Projects</h2>
        <div class="mb-4 bg-white rounded-lg shadow-md p-4">
            <div class="flex flex-col md:flex-row md:items-center md:space-x-4">
                <div class="flex-grow mb-3 md:mb-0">
                    <div class="relative">
                        <input type="text" id="completedProjectSearch" placeholder="Search completed projects..."
                            class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-tertiary">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <select id="completedProjectSort" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-tertiary">
                        <option value="date-desc">Newest First</option>
                        <option value="date-asc">Oldest First</option>
                        <option value="budget-desc">Highest Budget</option>
                        <option value="budget-asc">Lowest Budget</option>
                    </select>
                    <button id="resetCompletedFilters" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-300">
                        <i class="fas fa-undo mr-1"></i>Reset
                    </button>
                </div>
            </div>
        </div>
        <div id="completedProjectsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
            {% for project in all_projects %}
                {% if project.status == 'completed' %}
                <div class="bg-white rounded-lg shadow-md overflow-hidden border border-green-200 hover:shadow-lg transition-all duration-300">
                    <div class="h-40 bg-tertiary relative overflow-hidden">
                        {% if project.image %}
                            <img src="{{ project.image.url }}" alt="{{ project.name }}" class="w-full h-full object-cover">
                        {% elif project.latest_image %}
                            <img src="{{ project.latest_image.url }}" alt="{{ project.name }}" class="w-full h-full object-cover">
                        {% else %}
                            <div class="w-full h-full flex items-center justify-center bg-quaternary/80">
                                <i class="fas fa-project-diagram text-5xl text-white opacity-50"></i>
                            </div>
                        {% endif %}
                        <div class="absolute top-0 right-0 m-2">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-300">
                                <i class="fas fa-check-circle mr-1"></i>Completed
                            </span>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-4">
                            <h3 class="text-xl font-bold text-white">{{ project.name|title }}</h3>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-user-tie text-tertiary mr-2"></i>
                            <span class="text-sm">{{ project.chairman.get_full_name|title }}</span>
                        </div>
                        <div class="flex items-center mb-2">
                            <i class="fas fa-money-bill-wave text-tertiary mr-2"></i>
                            <span class="text-sm">₱{{ project.allocated_budget|intcomma }}</span>
                        </div>
                        <div class="flex items-center mb-2">
                            <i class="fas fa-calendar-check text-tertiary mr-2"></i>
                            <span class="text-sm">{{ project.end_date|date:"M d, Y" }}</span>
                        </div>
                        {% with total_expenses=project.expenses.all|sum_expenses %}
                        <div class="flex items-center mb-2">
                            <i class="fas fa-receipt text-tertiary mr-2"></i>
                            <span class="text-sm">₱{{ total_expenses|intcomma }} spent</span>
                        </div>
                        {% endwith %}
                        <div class="mt-4 flex flex-col xs:flex-row space-y-2 xs:space-y-0 justify-between">
                            <a href="{% url 'project_detail' project.id %}" class="inline-flex items-center px-3 py-1 bg-tertiary text-white rounded hover:bg-quaternary transition duration-300 text-xs sm:text-sm justify-center xs:justify-start">
                                <i class="fas fa-eye mr-1"></i>Details
                            </a>
                            <a href="{% url 'project_accomplishment_report' project.id %}" class="inline-flex items-center px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition duration-300 text-xs sm:text-sm justify-center xs:justify-start">
                                <i class="fas fa-file-alt mr-1"></i>Reports
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% empty %}
                <p class="col-span-full text-center text-gray-500 py-8">No completed projects found.</p>
            {% endfor %}

            {% if not all_projects|filter_completed %}
                <p class="col-span-full text-center text-gray-500 py-8">No completed projects found.</p>
            {% endif %}
        </div>
    </div>

    <div class="mb-8">
        <h2 class="text-2xl font-semibold mb-4 text-tertiary"><i class="fas fa-users mr-2"></i>Chairmen</h2>
        <div class="mb-4 bg-white rounded-lg shadow-md p-4">
            <div class="relative">
                <input type="text" id="chairmenSearch" placeholder="Search by name, email, projects..."
                    class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-tertiary">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-search text-gray-400"></i>
                </div>
            </div>
        </div>
        <div id="chairmenContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
        {% for chairman in chairmen %}
            <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 border-t-4 border-tertiary">
                <h2 class="text-lg sm:text-xl font-semibold mb-3 sm:mb-4 text-tertiary"><i class="fas fa-user-circle mr-2"></i>{{ chairman.get_full_name|title }}</h2>
                <p class="flex items-center mb-2 text-sm sm:text-base"><i class="fas fa-envelope text-quaternary mr-2"></i>{{ chairman.email }}</p>
                <p class="flex items-center mb-2 text-sm sm:text-base"><i class="fas fa-folder-open text-primary mr-2"></i>Total Projects: {{ chairman.projects.count }}</p>
                <p class="flex items-center mb-2 text-sm sm:text-base"><i class="fas fa-money-bill-wave text-quaternary mr-2"></i>Total Budget: ₱{{ chairman.total_budget|floatformat:2|intcomma }}</p>
                <p class="flex items-center mb-2 text-sm sm:text-base"><i class="fas fa-receipt text-quaternary mr-2"></i>Total Expenses: ₱{{ chairman.total_expenses|floatformat:2|intcomma }}</p>
                <div class="mt-3 sm:mt-4">
                    <h3 class="font-semibold text-tertiary text-sm sm:text-base"><i class="fas fa-list-ul mr-2"></i>Projects:</h3>
                    <ul class="list-disc pl-5 mt-2 text-xs sm:text-sm">
                        {% for project in chairman.projects.all %}
                            <li class="mb-1">{{ project.name|title }} - ₱{{ project.budget|floatformat:2|intcomma }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        {% empty %}
            <p class="col-span-full text-center text-gray-500">No chairmen found matching your search criteria.</p>
        {% endfor %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Toggle advanced search options
            const toggleAdvancedSearch = document.getElementById('toggleAdvancedSearch');
            const advancedSearchOptions = document.getElementById('advancedSearchOptions');
            const filterChevron = document.getElementById('filterChevron');

            if (toggleAdvancedSearch && advancedSearchOptions) {
                toggleAdvancedSearch.addEventListener('click', function() {
                    advancedSearchOptions.classList.toggle('hidden');
                    filterChevron.classList.toggle('transform');
                    filterChevron.classList.toggle('rotate-180');
                });
            }

            // ===== MAIN BUDGETS SEARCH =====
            const budgetSearch = document.getElementById('budgetSearch');
            const budgetYearFilter = document.getElementById('budgetYearFilter');
            const resetBudgetFilters = document.getElementById('resetBudgetFilters');
            const budgetTableRows = document.querySelector('#mainBudgetsTable tbody')?.querySelectorAll('tr');

            function updateBudgetTotals(visibleRows) {
                let totalBudget = 0;
                let allocatedBudget = 0;
                let remainingBudget = 0;

                visibleRows.forEach(row => {
                    if (row.style.display !== 'none') {
                        totalBudget += parseFloat(row.children[3].textContent.replace('₱', '').replace(/,/g, ''));
                        allocatedBudget += parseFloat(row.children[4].textContent.replace('₱', '').replace(/,/g, ''));
                        remainingBudget += parseFloat(row.children[5].textContent.replace('₱', '').replace(/,/g, ''));
                    }
                });

                document.getElementById('totalBudgetSum').textContent = '₱' + totalBudget.toLocaleString();
                document.getElementById('allocatedBudgetSum').textContent = '₱' + allocatedBudget.toLocaleString();
                document.getElementById('remainingBudgetSum').textContent = '₱' + remainingBudget.toLocaleString();
            }

            function filterBudgetTable() {
                const searchTerm = budgetSearch?.value.toLowerCase() || '';
                const yearFilter = budgetYearFilter?.value || '';

                if (!budgetTableRows) return;

                budgetTableRows.forEach(row => {
                    const yearCell = row.children[0].textContent.trim();
                    const rowText = Array.from(row.children)
                        .map(cell => cell.textContent.toLowerCase())
                        .join(' ');

                    const matchesSearch = searchTerm === '' || rowText.includes(searchTerm);
                    const matchesYear = yearFilter === '' || yearCell === yearFilter;

                    if (matchesSearch && matchesYear) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });

                updateBudgetTotals(budgetTableRows);
            }

            if (budgetSearch) {
                budgetSearch.addEventListener('input', filterBudgetTable);
            }

            if (budgetYearFilter) {
                budgetYearFilter.addEventListener('change', filterBudgetTable);
            }

            if (resetBudgetFilters) {
                resetBudgetFilters.addEventListener('click', function() {
                    if (budgetSearch) budgetSearch.value = '';
                    if (budgetYearFilter) budgetYearFilter.value = '';
                    filterBudgetTable();
                });
            }

            // Initialize budget totals
            if (budgetTableRows) {
                updateBudgetTotals(budgetTableRows);
            }

            // ===== PROJECTS SEARCH =====
            const projectSearch = document.getElementById('projectSearch');
            const projectStatusFilter = document.getElementById('projectStatusFilter');
            const projectBudgetFilter = document.getElementById('projectBudgetFilter');
            const resetProjectFilters = document.getElementById('resetProjectFilters');
            const projectTableRows = document.querySelector('#projectsTable tbody')?.querySelectorAll('tr');

            function updateProjectTotals(visibleRows) {
                let totalBudget = 0;

                visibleRows.forEach(row => {
                    if (row.style.display !== 'none') {
                        const budgetText = row.children[2].textContent;
                        totalBudget += parseFloat(budgetText.replace('₱', '').replace(/,/g, ''));
                    }
                });

                document.getElementById('totalProjectBudget').textContent = '₱' + totalBudget.toLocaleString();
            }

            function filterProjects() {
                const searchTerm = projectSearch?.value.toLowerCase() || '';
                const statusFilter = projectStatusFilter?.value || '';
                const budgetFilter = projectBudgetFilter?.value || '';

                if (!projectTableRows) return;

                projectTableRows.forEach(row => {
                    // Extract data from row
                    const name = row.children[0].textContent.toLowerCase();
                    const chairman = row.children[1].textContent.toLowerCase();
                    const budget = parseFloat(row.children[2].textContent.replace('₱', '').replace(/,/g, ''));
                    const statusCell = row.children[5];
                    const statusText = statusCell.textContent.replace(/\s+/g, ' ').trim().toLowerCase();

                    // Determine status
                    let status = '';
                    if (statusText.includes('completed')) status = 'completed';
                    else if (statusText.includes('in progress')) status = 'in-progress';
                    else if (statusText.includes('not started')) status = 'not-started';
                    else if (statusText.includes('ended')) status = 'ended';

                    // Determine budget category
                    let budgetCategory = '';
                    if (budget < 50000) budgetCategory = 'low';
                    else if (budget <= 200000) budgetCategory = 'medium';
                    else budgetCategory = 'high';

                    // Combine all searchable text
                    const rowText = name + ' ' + chairman + ' ' + statusText;

                    // Apply filters
                    const matchesSearch = searchTerm === '' || rowText.includes(searchTerm);
                    const matchesStatus = statusFilter === '' || status === statusFilter;
                    const matchesBudget = budgetFilter === '' || budgetCategory === budgetFilter;

                    if (matchesSearch && matchesStatus && matchesBudget) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });

                updateProjectTotals(projectTableRows);
            }

            if (projectSearch) {
                projectSearch.addEventListener('input', filterProjects);
            }

            if (projectStatusFilter) {
                projectStatusFilter.addEventListener('change', filterProjects);
            }

            if (projectBudgetFilter) {
                projectBudgetFilter.addEventListener('change', filterProjects);
            }

            if (resetProjectFilters) {
                resetProjectFilters.addEventListener('click', function() {
                    if (projectSearch) projectSearch.value = '';
                    if (projectStatusFilter) projectStatusFilter.value = '';
                    if (projectBudgetFilter) projectBudgetFilter.value = '';
                    filterProjects();
                });
            }

            // Initialize project totals
            if (projectTableRows) {
                updateProjectTotals(projectTableRows);
            }

            // ===== PENDING USERS SEARCH =====
            const pendingUserSearch = document.getElementById('pendingUserSearch');
            const pendingUserRows = document.querySelector('#pendingUsersTable tbody')?.querySelectorAll('tr');

            function filterPendingUsers() {
                const searchTerm = pendingUserSearch?.value.toLowerCase() || '';

                if (!pendingUserRows) return;

                let hasVisibleRows = false;

                pendingUserRows.forEach(row => {
                    // Skip the "No users pending approval" row
                    if (row.cells.length === 1 && row.cells[0].colSpan > 1) {
                        return;
                    }

                    const username = row.cells[0].textContent.toLowerCase();
                    const email = row.cells.length > 1 ? row.cells[1].textContent.toLowerCase() : '';
                    const dateJoined = row.cells.length > 2 ? row.cells[2].textContent.toLowerCase() : '';

                    const rowText = username + ' ' + email + ' ' + dateJoined;

                    if (searchTerm === '' || rowText.includes(searchTerm)) {
                        row.style.display = '';
                        hasVisibleRows = true;
                    } else {
                        row.style.display = 'none';
                    }
                });

                // Show or hide the "No users" message
                const noUsersRow = Array.from(pendingUserRows).find(row =>
                    row.cells.length === 1 && row.cells[0].colSpan > 1);

                if (noUsersRow) {
                    noUsersRow.style.display = hasVisibleRows ? 'none' : '';
                }
            }

            if (pendingUserSearch) {
                pendingUserSearch.addEventListener('input', filterPendingUsers);
            }

            // ===== COMPLETED PROJECTS SEARCH =====
            const completedProjectSearch = document.getElementById('completedProjectSearch');
            const completedProjectSort = document.getElementById('completedProjectSort');
            const resetCompletedFilters = document.getElementById('resetCompletedFilters');
            const completedProjects = document.querySelectorAll('#completedProjectsContainer > div:not(.col-span-full)');

            function filterAndSortCompletedProjects() {
                const searchTerm = completedProjectSearch?.value.toLowerCase() || '';
                const sortOption = completedProjectSort?.value || 'date-desc';

                if (!completedProjects.length) return;

                // First filter
                let visibleProjects = [];
                let hasVisibleProjects = false;

                completedProjects.forEach(project => {
                    const projectName = project.querySelector('h3')?.textContent.toLowerCase() || '';
                    const chairman = project.querySelector('.fas.fa-user-tie')?.nextSibling?.textContent.toLowerCase() || '';
                    const budget = project.querySelector('.fas.fa-money-bill-wave')?.nextSibling?.textContent.toLowerCase() || '';
                    const date = project.querySelector('.fas.fa-calendar-check')?.nextSibling?.textContent.toLowerCase() || '';

                    const projectText = projectName + ' ' + chairman + ' ' + budget + ' ' + date;

                    if (searchTerm === '' || projectText.includes(searchTerm)) {
                        project.style.display = '';
                        visibleProjects.push(project);
                        hasVisibleProjects = true;
                    } else {
                        project.style.display = 'none';
                    }
                });

                // Then sort visible projects
                if (visibleProjects.length > 0) {
                    const container = document.getElementById('completedProjectsContainer');

                    // Sort the visible projects
                    visibleProjects.sort((a, b) => {
                        if (sortOption === 'date-desc' || sortOption === 'date-asc') {
                            const dateA = a.querySelector('.fas.fa-calendar-check')?.nextSibling?.textContent || '';
                            const dateB = b.querySelector('.fas.fa-calendar-check')?.nextSibling?.textContent || '';

                            // Convert dates for comparison (assuming format is "MMM D, YYYY")
                            const timeA = new Date(dateA).getTime();
                            const timeB = new Date(dateB).getTime();

                            return sortOption === 'date-desc' ? timeB - timeA : timeA - timeB;
                        } else {
                            // Budget sorting
                            const budgetTextA = a.querySelector('.fas.fa-money-bill-wave')?.nextSibling?.textContent || '';
                            const budgetTextB = b.querySelector('.fas.fa-money-bill-wave')?.nextSibling?.textContent || '';

                            const budgetA = parseFloat(budgetTextA.replace('₱', '').replace(/,/g, ''));
                            const budgetB = parseFloat(budgetTextB.replace('₱', '').replace(/,/g, ''));

                            return sortOption === 'budget-desc' ? budgetB - budgetA : budgetA - budgetB;
                        }
                    });

                    // Reorder the DOM
                    visibleProjects.forEach(project => {
                        container.appendChild(project);
                    });
                }

                // Show or hide the "No projects" message
                const noProjectsMessage = document.querySelector('#completedProjectsContainer > p.col-span-full');
                if (noProjectsMessage) {
                    noProjectsMessage.style.display = hasVisibleProjects ? 'none' : 'block';
                }
            }

            if (completedProjectSearch) {
                completedProjectSearch.addEventListener('input', filterAndSortCompletedProjects);
            }

            if (completedProjectSort) {
                completedProjectSort.addEventListener('change', filterAndSortCompletedProjects);
            }

            if (resetCompletedFilters) {
                resetCompletedFilters.addEventListener('click', function() {
                    if (completedProjectSearch) completedProjectSearch.value = '';
                    if (completedProjectSort) completedProjectSort.value = 'date-desc';
                    filterAndSortCompletedProjects();
                });
            }

            // ===== CHAIRMEN SEARCH =====
            const chairmenSearch = document.getElementById('chairmenSearch');
            const chairmenCards = document.querySelectorAll('#chairmenContainer > div:not(.col-span-full)');

            function filterChairmen() {
                const searchTerm = chairmenSearch?.value.toLowerCase() || '';

                if (!chairmenCards.length) return;

                let hasVisibleChairmen = false;

                chairmenCards.forEach(card => {
                    const name = card.querySelector('h2')?.textContent.toLowerCase() || '';
                    const email = card.querySelector('.fas.fa-envelope')?.nextSibling?.textContent.toLowerCase() || '';
                    const projects = card.querySelector('ul')?.textContent.toLowerCase() || '';

                    const cardText = name + ' ' + email + ' ' + projects;

                    if (searchTerm === '' || cardText.includes(searchTerm)) {
                        card.style.display = '';
                        hasVisibleChairmen = true;
                    } else {
                        card.style.display = 'none';
                    }
                });

                // Show or hide the "No chairmen" message
                const noChairmenMessage = document.querySelector('#chairmenContainer > p.col-span-full');
                if (noChairmenMessage) {
                    noChairmenMessage.style.display = hasVisibleChairmen ? 'none' : 'block';
                }
            }

            if (chairmenSearch) {
                chairmenSearch.addEventListener('input', filterChairmen);
            }

            // Initialize all filters
            filterBudgetTable();
            filterProjects();
            filterPendingUsers();
            filterAndSortCompletedProjects();
            filterChairmen();
        });
    </script>
{% endblock %}
